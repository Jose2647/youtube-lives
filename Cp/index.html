<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
       <!-- 
       <link rel="stylesheet" href="styles.css"/>
       <link rel="stylesheet" href="styles-divs-horizontais.css"/>
       -->
       <link rel="stylesheet" href="styles-global.css"/>
    <link rel="stylesheet" href="styles-header-login.css"/>
    <link rel="stylesheet" href="styles-lives.css"/>
    <link rel="stylesheet" href="styles-divs-horizontais.css"/> <link rel="stylesheet" href="styles-modals-apostas.css"/>
    <link rel="stylesheet" href="styles-chat.css"/>
    <link rel="stylesheet" href="styles-notificacoes.css"/>
  
    <title>Sistema de Jogos e Transmiss√µes</title>
</head>
<body>
  
  
  <header>
    <div class="header-content">
        <h2 class="header-title">Meu App</h2>
        <div class="header-actions">

            <!-- outros bot√µes -->
                <button onclick="verRankingUsuarios()">Ranking</button>
    <button onclick="verNotificacoes()">Notifica√ß√µes</button>
               <div class="profile-icon" id="profileIcon" onclick="toggleProfileMenu()">üë§</div>
        </div>
    </div>

  <!-- Menu flutuante do perfil -->
  <div class="login-floating" id="loginFloating">
    <!-- Conte√∫do ser√° preenchido pelo JavaScript -->
  </div>
 <!-- Overlay para fechar o menu -->
  <div class="overlay" id="overlay" onclick="toggleProfileMenu()"></div>
  
</header>
    <h1>Sistema de Jogos e Transmiss√µes</h1>
    
    <!-- Se√ß√£o de Jogos -->
    <div id="secao-jogos" class="secao">
        <h2>Jogos</h2>

     
     
                 <button onclick="adicionarJogo()" >
                + Criar novo Jogo
            </button>
            <button onclick="colarJogo()" >
                Colar Jogo
            </button>
    
        <div id="lista-jogos"></div>
    </div>
    
    <!-- Se√ß√£o de Est√°dios -->
    <div id="secao-estadios" class="secao" style="display:none;">
        <h2>Est√°dios</h2>
        <button onclick="voltarParaJogos()">‚Üê Voltar para Jogos</button>

        <div id="lista-estadios"></div>
        
                    <button onclick="colarEstadioCopiado()" >
                Colar estadio
            </button>
    </div>
    
  
    <div id="secao-times" class="secao" style="display:none;">
    <h2>Times</h2>
    <button onclick="voltarParaEstadios()">‚Üê Voltar para Est√°dios</button>
    
    <!-- BOT√ÉO COLAR FIXO -->
    <!--
    <button onclick="colarTimeCopiado(jogoSelecionadoId, estadioSelecionadoId)" 
            style="background:#6f42c1; color:white; padding:8px 12px; border:none; border-radius:5px; font-size:0.9em; margin:10px 5px;">
        Colar Time Copiado
    </button>
    -->
                        <button onclick="colarTimeCopiado(jogoSelecionadoId, estadioSelecionadoId)" >
                Colar Time Copiado
            </button>

    <div id="lista-times"></div>
</div>
    

  


</div>






<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<script src="/socket.io/socket.io.js">
  
</script>

<!--
<script src="styles.js">
</script>
  
-->
<script
>
  
 // const signaling = io(); // socket.io client
//src="js/Variaveis.js" 
let localStream = null;
const pcConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' },
        { urls: 'stun:stun.stunprotocol.org:3478' },
        { urls: 'stun:stun.voiparound.com' },
        // Adicione mais STUNs gratuitos se necess√°rio, sem TURN
    ]
};
let currentGameId = 'default_room'; // Sala "em foco"
let joinedRooms = new Set(['default_room']); // <-- ADICIONE ISSO
let startButton,  messageInput, sendButton, sendCustomDataButton, messagesDiv, localVideo, remoteContainer;
let roomsSelect, joinRoomButton, createRoomButton;
let dados = { // Inicializando dados se n√£o definido externamente
  apostasUsuarios: [],
  desafiosUsuarios: [],
  chats: [],
  usuarios: [],
  jogos: [],
  transacoes: [],
  version: Date.now()
}; // Ajuste conforme necess√°rio
let jogoTemporarioParaCompartilhar = null;
let acoesEstadioVisiveis = true;
let modalChatAtual = null;
let jogoCopiado = null;
let estadioCopiado = null; // Armazena o est√°dio copiado
let timeCopiado = null;
let liveCopiada = null;
let cardCopiado = null;
let divCopiada = null;
let scrollContainerCopiado = null;
let iframerCopiado = null;
// === SISTEMA DE TOGGLE GLOBAL ===
const toggleStates = {
    divs: {},
    scrollContainers: {},
    iframers: {},
    videoInfo: JSON.parse(localStorage.getItem('videoInfoVisible')) ?? true
};
let toggleStatesLive = {};

let toggleStatesScrollContainer = {};
let toggleStatesDiv = {};
let toggleStatesIframer = {};
let currentSelectedGameId = null;
const dataChannels = {};
let usuarioLogado = null;
let streamerLogado = null;
let notificacoes = [];
let socket = null;
let eventos = [];
let jogoSelecionadoId = null;
let estadioSelecionadoId = null;
let timeSelecionadoId = null;
let liveSelecionadoId = null;
let audioContext = null;
let audioAnalyser = null;
let audioParticipants = new Map();
let peers = {};
let chatModalAberto = false;







const TOKEN_JWT = localStorage.getItem('jwtToken') || '';  // Do login existente

    const configLives = {
        maxIframes: 8,
        maxCardsUsuario: 6,
        maxDivsPorLive: 4,
        maxCardsPorDiv: 8,
        iframeWidth: "180px",
        iframeHeight: "200px",
        autoplay: 1,
        mute: 1,
        enablejsapi: 1,
        tamanhosDisponiveis: {
            pequeno: { width: "100px", height: "161px", label: "Pequeno" },
            medio: { width: "150px", height: "241px", label: "M√©dio" },
            grande: { width: "200px", height: "321px", label: "Grande" },
            extraGrande: { width: "350px", height: "401px", label: "Extra Grande" }
        },
        tamanhosCards: {
            pequeno: { width: "135px", height: "135px", label: "Pequeno" },
            medio: { width: "180px", height: "180px", label: "M√©dio" },
            grande: { width: "225px", height: "225px", label: "Grande" },
            extraGrande: { width: "270px", height: "270px", label: "Extra Grande" }
        },
        alturasDiv: {
            pequeno: { height: "1200px", label: "Pequeno" },
            medio: { height: "1200px", label: "M√©dio" },
            grande: { height: "1200px", label: "Grande" },
            extraGrande: { height: "1200px", label: "Extra Grande" }
        }
    };
      window.configLives = configLives;

      



// variaveis-globais.js







  
        // === CONFIG (AJUSTE AQUI) ===
   const API_BASE = 'http://localhost:3000';  // Seu backend URL
    const SOCKET_SERVER = 'http://localhost:3000';  // Mesmo do chat, se compartilhado
    
    /*
const API_BASE = 'https://youtube-lives.onrender.com';
    const SOCKET_SERVER = 'https://youtube-lives.onrender.com';  // Mesmo do chat, se compartilhado
    const SIGNALING_SERVER = 'wss://youtube-lives.onrender.com';
    
    */
    
    



function getCurrentGameId() {
    // Se o array de jogos existe e n√£o est√° vazio, usa o ID do primeiro jogo.
    // Em uma aplica√ß√£o real, voc√™ pegaria isso da URL ou de uma sele√ß√£o do usu√°rio.
    return dados.jogos && dados.jogos.length > 0 ? dados.jogos[0].id : 'default_lobby';
}



    /*
        // === CONFIG (AJUSTE AQUI) ===
   const API_BASE = 'http://localhost:3000';  // Seu backend URL
    const SOCKET_SERVER = 'http://localhost:3000';  // Mesmo do chat, se compartilhado
const API_BASE = 'https://youtube-lives.onrender.com';
    const SOCKET_SERVER = 'https://youtube-lives.onrender.com';  // Mesmo do chat, se compartilhado
    const SIGNALING_SERVER = 'wss://youtube-lives.onrender.com';
    
    */

  // Fun√ß√£o para buscar dados do backend
async function buscarDadosBackend(endpoint) {
    try {
        const response = await fetch(`${API_BASE}${endpoint}`);
        if (!response.ok) throw new Error(`Erro ${response.status}`);
        
        const dadosRes = await response.json();
        //console.log(`${endpoint}:`, Array.isArray(dadosRes) ? dadosRes.length : 1, 'itens');
        return dadosRes;
        
    } catch (error) {
        console.error(`${endpoint}:`, error.message);
        return null;
    }
}
// Fun√ß√£o principal para carregar dados
async function carregarDadosBackend() {
    try {
        //console.log('Carregando dados do backend...');
        
        const [
            usuariosBackend, 
            apostasBackend, 
            desafiosBackend, 
            chatsBackend, 
            jogosBackend
        ] = await Promise.all([
            buscarDadosBackend('/api/users'),
            buscarDadosBackend('/api/apostas'),
            buscarDadosBackend('/api/desafios'),
            buscarDadosBackend('/api/chats'),
            buscarDadosBackend('/api/jogos') // ou '/api/jogos-completos' se preferir
        ]);

        // Atribuir dados diretamente
        Object.assign(dados, {
            usuarios: usuariosBackend || [],
            apostasUsuarios: apostasBackend || [],
            desafiosUsuarios: desafiosBackend || [],
            chats: chatsBackend || [],
            jogos: jogosBackend || []
        });

        //console.log('Dados carregados:');
        //console.log(`Usu√°rios: ${dados.usuarios.length}`);
      //  console.log(`Apostas: ${dados.apostasUsuarios.length}`);
        //console.log(`Desafios: ${dados.desafiosUsuarios.length}`);
        //console.log(`Chats: ${dados.chats.length}`);
        console.log(`Jogos: ${dados.jogos.length}`);
        
        return true;
        
    } catch (error) {
        console.error('Erro no carregamento:', error);
        return false;
    }
}
    
// Fun√ß√£o inicializadora
async function inicializar() {
    console.log('Iniciando sistema...');
    
    const sucesso = await carregarDadosBackend();
    
    if (sucesso) {
      salvarDados()
      console.log("___dados",dados)
   //   console.log("___dados.jogos",dados.jogos)
        carregarJogos(); // sua fun√ß√£o que renderiza a UI
        console.log('Sistema inicializado com sucesso');
    } else {
        document.getElementById('app').innerHTML = `
            <div class="erro">
                <h2>Erro ao conectar com o servidor</h2>
                <p>Verifique se o backend est√° rodando em <code>https://youtube-lives.onrender.com</code></p>
                <button onclick="location.reload()">Tentar novamente</button>
            </div>
        `;
    }
}


// Iniciar automaticamente
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializar);
} else {
    inicializar();
}



///////
///////
///////
///////

// ===== LOGIN PRINCIPAL =====
function fazerLogin() {
    const tipo = prompt("Voc√™ √©:\n1 - Usu√°rio\n2 - Streamer\n\nDigite 1 ou 2:");
    
    if (tipo === "1") {
        loginUsuario();
    } else if (tipo === "2") {
        loginStreamer();
    } else {
        alert("Op√ß√£o inv√°lida!");
    }
}
function loginUsuario() {
    const usuario = prompt("Usu√°rio:");
    if (!usuario) {
        alert("Usu√°rio √© obrigat√≥rio!");
        return;
    }
    
    const senha = prompt("Senha:");
    if (!senha) {
        alert("Senha √© obrigat√≥ria!");
        return;
    }
    
    const usuarioEncontrado = dados.usuarios.find(u => u.usuario === usuario && u.senha === senha);
    
    if (usuarioEncontrado) {
        usuarioLogado = usuarioEncontrado;
        salvarSessao();
        alert(`Bem-vindo, ${usuarioLogado.nome}!`);
        atualizarInterfaceLogin();
    } else {
        if (confirm("Usu√°rio n√£o encontrado. Deseja criar uma nova conta?")) {
            criarNovoUsuario(usuario, senha);
        }
    }
}
function loginStreamer() {
    const usuario = prompt("Usu√°rio do Streamer:");
    if (!usuario) {
        alert("Usu√°rio √© obrigat√≥rio!");
        return;
    }
    
    const senha = prompt("Senha:");
    if (!senha) {
        alert("Senha √© obrigat√≥ria!");
        return;
    }
    
    const streamerEncontrado = encontrarStreamerGlobal(usuario, senha);
    
    if (streamerEncontrado) {
        streamerLogado = streamerEncontrado;
        streamerLogado.online = true;
        salvarSessao();
        alert(`Bem-vindo, Streamer ${streamerLogado.nome}!`);
        atualizarInterfaceLogin();
    } else {
        if (confirm("Streamer n√£o encontrado. Deseja criar uma nova conta de streamer?")) {
            criarNovoStreamer(usuario, senha);
        }
    }
}
// social.js - VERS√ÉO CORRIGIDA
function adicionarAmigo(usuarioAlvo) {
    if (!usuarioLogado) {
        alert("Fa√ßa login primeiro!");
        return;
    }
    
    if (usuarioAlvo === usuarioLogado.nome) {
        alert("Voc√™ n√£o pode adicionar a si mesmo!");
        return;
    }
    
    if (!usuarioLogado.amigos) usuarioLogado.amigos = [];
    
    if (usuarioLogado.amigos.includes(usuarioAlvo)) {
        alert("Voc√™ j√° √© amigo deste usu√°rio!");
        return;
    }
    
    usuarioLogado.amigos.push(usuarioAlvo);
    adicionarNotificacao("Novo amigo!", `Voc√™ e ${usuarioAlvo} agora s√£o amigos!`, 'sucesso');
    alert(`Agora voc√™ √© amigo de ${usuarioAlvo}!`);
}
function verAmigos() {
    if (!usuarioLogado) {
        alert("Fa√ßa login primeiro!");
        return;
    }
    
    if (!usuarioLogado.amigos || usuarioLogado.amigos.length === 0) {
        alert("Voc√™ n√£o tem amigos adicionados");
        return;
    }
    
    let lista = "=== SEUS AMIGOS ===\n\n";
    usuarioLogado.amigos.forEach((amigo, index) => {
        const usuario = dados.usuarios.find(u => u.nome === amigo);
        if (usuario) {
            lista += `üë§ ${usuario.nome}\n`;
            lista += `M√©rito: ${usuario.merito}\n`;
            lista += `[Desafiar - digite 'd ${index}'] [Ver Perfil - 'v ${index}']\n\n`;
        }
    });
    
    lista += "\nComandos: 'd [n√∫mero]' - desafiar amigo | 'v [n√∫mero]' - ver perfil";
    const comando = prompt(lista);
    
    if (comando) {
        if (comando.startsWith('d ')) {
            const index = parseInt(comando.split(' ')[1]);
            if (!isNaN(index) && index >= 0 && index < usuarioLogado.amigos.length) {
                desafiarAmigo(usuarioLogado.amigos[index]);
            }
        } else if (comando.startsWith('v ')) {
            const index = parseInt(comando.split(' ')[1]);
            if (!isNaN(index) && index >= 0 && index < usuarioLogado.amigos.length) {
                verPerfilAmigo(usuarioLogado.amigos[index]);
            }
        }
    }
}
function desafiarAmigo(nomeAmigo) {
    alert(`Funcionalidade de desafio para ${nomeAmigo} em desenvolvimento...`);
    // Implementar l√≥gica de desafio entre amigos
}
function verPerfilAmigo(nomeAmigo) {
    const amigo = dados.usuarios.find(u => u.nome === nomeAmigo);
    if (!amigo) {
        alert("Amigo n√£o encontrado!");
        return;
    }
    
    let perfil = `=== PERFIL DE ${amigo.nome} ===\n\n`;
    perfil += `M√©rito: ${amigo.merito} pontos\n`;
    perfil += `Desafios cumpridos: ${amigo.desafiosCumpridos || 0}\n`;
    perfil += `Pagamentos realizados: ${amigo.pagamentosRealizados || 0}\n`;
    
    alert(perfil);
}
// ===== CRIA√á√ÉO DE CONTAS =====
function criarNovoUsuario(usuario, senha) {
    const nome = prompt("Seu nome completo:");
    if (!nome) return;
    
    const confirmarSenha = prompt("Confirme a senha:");
    if (senha !== confirmarSenha) {
        alert("As senhas n√£o coincidem!");
        return;
    }
    
    const novoUsuario = {
        id: Date.now(),
        nome: nome,
        usuario: usuario,
        senha: senha,
        imagem: "default-usuario.png",
        chavePix: "",
        merito: 100,
        desafiosCumpridos: 0,
        desafiosFalhados: 0,
        pagamentosRealizados: 0,
        pagamentosPendentes: 0,
        amigos: [],
        dataCriacao: new Date().toLocaleString()
    };
    
    dados.usuarios.push(novoUsuario);
    usuarioLogado = novoUsuario;
    salvarSessao();
    salvarDados();
    
    alert(`Conta criada com sucesso! Bem-vindo, ${nome}!\n\nUsu√°rio: ${usuario}\nSenha: ${senha}\nM√©rito inicial: 100 pontos`);
    atualizarInterfaceLogin();
}
function criarNovoStreamer(usuario, senha) {
    const nome = prompt("Nome do Streamer:");
    if (!nome) return;
    
    const confirmarSenha = prompt("Confirme a senha:");
    if (senha !== confirmarSenha) {
        alert("As senhas n√£o coincidem!");
        return;
    }
    
    if (!dados.jogos.length) {
        alert("Primeiro crie um jogo, est√°dio e time!");
        return;
    }
    
    const novostreamer = {
        id: Date.now(),
        nome: nome,
        usuario: usuario,
        senha: senha,
        imagem: "default-streamer.png",
        chavePix: "",
        online: true,
        merito: 500,
        videos: [],
        desafiosRecebidos: [],
        desafiosEnviados: []
    };
    
    const novaLive = criarLiveParaStreamer(nome, usuario, novostreamer);
    
    streamerLogado = novostreamer;
    salvarSessao();
    salvarDados();
    
    alert(`Streamer e live criados com sucesso!\n\nStreamer: ${nome}\nUsu√°rio: ${usuario}\nSenha: ${senha}\nLive criada automaticamente!`);
    atualizarInterfaceLogin();
    
    mostrarSecao('lives');
    carregarLivesDoTime(dados.jogos[0].id, dados.jogos[0].estadios[0].id, dados.jogos[0].estadios[0].times[0].id);
}
// ===== SISTEMA DE PIX UNIFICADO =====
function configurarChavePix() {
    const usuario = usuarioLogado || streamerLogado;
    if (!usuario) {
        alert("Fa√ßa login primeiro!");
        return;
    }
    
    const chaveAtual = usuario.chavePix || "N√£o configurada";
    const novaChave = prompt(`Sua chave PIX atual: ${chaveAtual}\n\nNova chave PIX (email, telefone, CPF, ou chave aleat√≥ria):\nDeixe em branco para remover:`, usuario.chavePix);
    
    if (novaChave !== null) {
        usuario.chavePix = novaChave.trim();
        salvarSessao();
        salvarDados();
        
        if (usuario.chavePix) {
            alert(`Chave PIX atualizada: ${usuario.chavePix}`);
        } else {
            alert("Chave PIX removida.");
        }
    }
}
// ===== INTERFACE DE USU√ÅRIO =====
function toggleProfileMenu() {
    const floatingMenu = document.getElementById('loginFloating');
    const overlay = document.getElementById('overlay');
    const profileIcon = document.getElementById('profileIcon');
    
    if (floatingMenu && floatingMenu.classList.contains('show')) {
        floatingMenu.classList.remove('show');
        if (overlay) overlay.classList.remove('show');
    } else {
        atualizarMenuPerfil();
        if (floatingMenu) floatingMenu.classList.add('show');
        if (overlay) overlay.classList.add('show');
    }
}
// ===== FUN√á√ïES AUXILIARES =====
function encontrarStreamerGlobal(usuario, senha) {
    for (const jogo of dados.jogos) {
        for (const estadio of jogo.estadios) {
            for (const time of estadio.times) {
                if (time.lives) {
                    for (const live of time.lives) {
                        if (live.streamers) {
                            const streamer = live.streamers.find(s => 
                                s.usuario === usuario && s.senha === senha
                            );
                            if (streamer) return streamer;
                        }
                    }
                }
            }
        }
    }
    return null;
}
function criarLiveParaStreamer(nomeStreamer, usuario, streamer) {
    const jogo = dados.jogos[0];
    const estadio = jogo.estadios[0];
    const time = estadio.times[0];
    
    const novaLive = {
        id: Date.now(),
        titulo: `Live de ${nomeStreamer}`,
        descricao: "Nova live criada automaticamente",
        status: "ativa",
        imagem: "default-live.png",
        criador: usuario,
        cards: [],
        streamers: [streamer],
        usuariosOnline: [],
        dataCriacao: new Date().toLocaleString()
    };
    
    if (!time.lives) time.lives = [];
    time.lives.push(novaLive);
    
    return novaLive;
}
// ===== PERFIL COMPLETO =====
function verPerfilCompleto() {
    const usuario = usuarioLogado || streamerLogado;
    if (!usuario) {
        alert("Fa√ßa login primeiro!");
        return;
    }
    
    let perfil = `=== PERFIL ===\n\n`;
    perfil += `Nome: ${usuario.nome}\n`;
    perfil += `Usu√°rio: ${usuario.usuario}\n`;
    perfil += `M√©rito: ${usuario.merito} pontos\n`;
    perfil += `Chave PIX: ${usuario.chavePix || "N√£o configurada"}\n`;
    
    if (usuarioLogado) {
        perfil += `\n--- Estat√≠sticas ---\n`;
        perfil += `Desafios cumpridos: ${usuario.desafiosCumpridos}\n`;
        perfil += `Desafios falhados: ${usuario.desafiosFalhados}\n`;
        perfil += `Pagamentos realizados: ${usuario.pagamentosRealizados}\n`;
        perfil += `Pagamentos pendentes: ${usuario.pagamentosPendentes}\n`;
        perfil += `Amigos: ${usuario.amigos ? usuario.amigos.length : 0}\n`;
    } else if (streamerLogado) {
        perfil += `\n--- Status ---\n`;
        perfil += `Online: ${streamerLogado.online ? 'Sim' : 'N√£o'}\n`;
        perfil += `V√≠deos: ${streamerLogado.videos ? streamerLogado.videos.length : 0}\n`;
    }
    
    perfil += `\n--- A√ß√µes ---\n`;
    perfil += `1. Configurar PIX\n`;
    perfil += `2. Ver Conquistas\n`;
    perfil += `3. Ver Ranking\n`;
    
    const opcao = prompt(perfil + "\nDigite o n√∫mero da a√ß√£o:");
    
    switch(opcao) {
        case "1":
            configurarChavePix();
            break;
        case "2":
            verConquistas();
            break;
        case "3":
            verRankingUsuarios();
            break;
    }
}
// ===== NOTIFICA√á√ïES =====
function mostrarNotificacao(mensagem, tipo = 'info', targetUser = null) {
    const notificacao = document.createElement('div');
    notificacao.className = `notificacao ${tipo}`;
    notificacao.innerHTML = mensagem;
    document.body.appendChild(notificacao);
    setTimeout(() => notificacao.remove(), 5000);
    if (targetUser && usuarioLogado && usuarioLogado.nome === targetUser) {
        notificacoes.push({ mensagem, tipo, data: new Date().toLocaleString() });
        salvarDados();
    } else if (!targetUser) {
        notificacoes.push({ mensagem, tipo, data: new Date().toLocaleString() });
        salvarDados();
    }
}
// ===== INICIALIZA√á√ÉO =====
document.addEventListener('DOMContentLoaded', function() {
    carregarSessao();
    atualizarInterfaceLogin();
    
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const floatingMenu = document.getElementById('loginFloating');
            const overlay = document.getElementById('overlay');
            if (floatingMenu) floatingMenu.classList.remove('show');
            if (overlay) overlay.classList.remove('show');
        }
    });
});




// ===== SISTEMA DE SESS√ÉO UNIFICADO =====
function salvarSessao() {
    const sessao = {
        usuarioLogado: usuarioLogado,
        streamerLogado: streamerLogado,
        timestamp: new Date().getTime()
    };
    localStorage.setItem('sistemaSessao', JSON.stringify(sessao));
}
function carregarSessao() {
    const sessaoSalva = localStorage.getItem('sistemaSessao');
    if (sessaoSalva) {
        const sessao = JSON.parse(sessaoSalva);
        
        const agora = new Date().getTime();
        const diffHoras = (agora - sessao.timestamp) / (1000 * 60 * 60);
        
        if (diffHoras < 24) {
            usuarioLogado = sessao.usuarioLogado;
            streamerLogado = sessao.streamerLogado;
            
            if (streamerLogado) {
                streamerLogado.online = true;
            }
        } else {
            limparSessao();
        }
    }
}
function limparSessao() {
    localStorage.removeItem('sistemaSessao');
    usuarioLogado = null;
    streamerLogado = null;
}
function salvarDados() {
    localStorage.setItem('sistemaTransmissao', JSON.stringify(dados));
   // localStorage.setItem('sistemaNotificacoes', JSON.stringify(notificacoes));
   // atualizarIndicadoresApostas()
}


// ===== LOGOUT UNIFICADO =====
function logout() {
    if (usuarioLogado) {
        alert(`At√© logo, ${usuarioLogado.nome}!`);
        usuarioLogado = null;
    }
    if (streamerLogado) {
        streamerLogado.online = false;
        alert(`At√© logo, Streamer ${streamerLogado.nome}!`);
        streamerLogado = null;
    }
    
    limparSessao();
    atualizarInterfaceLogin();
    
    const floatingMenu = document.getElementById('loginFloating');
    const overlay = document.getElementById('overlay');
    if (floatingMenu) floatingMenu.classList.remove('show');
    if (overlay) overlay.classList.remove('show');
}


// ===== INICIAR SISTEMA =====
if (document.readyState === 'loading') {
 //   document.addEventListener('DOMContentLoaded', inicializarSistemaApostas);
 //  document.addEventListener('DOMContentLoaded',inicializarSistemaApostasDesafios);
} else {
  //  inicializarSistemaApostas();
//    inicializarSistemaApostasDesafios();
}



  
  
  
  

function initChatUI() {
  let leaveRoomButton = document.getElementById('leaveRoomButton'); // <-- ADICIONE ESTA LINHA
  // Evita inicializar duas vezes
  if (!chatModalElement) return;

  startButton = document.getElementById('startButton');
//  callButton = document.getElementById('callButton');
//  hangupButton = document.getElementById('hangupButton');
  messageInput = document.getElementById('messageInput');
  sendButton = document.getElementById('sendButton');
  sendCustomDataButton = document.getElementById('sendCustomDataButton');
  messagesDiv = document.getElementById('messages');
  localVideo = document.getElementById('localVideo');
  remoteContainer = document.getElementById('remoteContainer'); // opcional container para m√∫ltiplos remotos
  roomsSelect = document.getElementById('roomsSelect'); // Novo: select para salas
  joinRoomButton = document.getElementById('joinRoomButton'); // Novo: bot√£o para join sala
  createRoomButton = document.getElementById('createRoomButton'); // Novo bot√£o para criar sala

  console.log('[UI] Inicializando elementos UI:', { startButton,  createRoomButton }); // Log adicionado para depurar UI

  // Protege caso elementos n√£o existam (safety)
  if (startButton) startButton.addEventListener('click', start);
 // if (callButton) callButton.addEventListener('click', callAll); // inicia offers para os peers existentes / novos
  //if (hangupButton) hangupButton.addEventListener('click', hangupAll);
  if (sendButton) sendButton.addEventListener('click', sendMessage);
  if (sendCustomDataButton) sendCustomDataButton.addEventListener('click', sendCustomData);

  // Novo: listeners para sele√ß√£o de sala e cria√ß√£o
  if (joinRoomButton) joinRoomButton.addEventListener('click', joinSelectedRoom);
  if (createRoomButton) createRoomButton.addEventListener('click', handleCreateRoom);

  // inicial state
  if (startButton) startButton.disabled = false;
  //if (callButton) callButton.disabled = true;
  //if (hangupButton) hangupButton.disabled = true;
  if (messageInput) messageInput.disabled = true;
  if (sendButton) sendButton.disabled = true;
  if (sendCustomDataButton) sendCustomDataButton.disabled = true;
  // ADICIONE ESTE BLOCO
  if (leaveRoomButton) {
    leaveRoomButton.addEventListener('click', () => {
      const roomToLeave = getCurrentGameId();
      if (!roomToLeave || roomToLeave === 'default_room') {
        alert('Voc√™ n√£o pode sair da sala padr√£o.');
        return;
      }
      if (confirm(`Tem certeza que deseja sair da sala "${roomToLeave}"?`)) {
        leaveIndividualRoom(roomToLeave);
      }
    });
  }

  if (messageInput) {
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  }

  // Carrega lista de salas ao iniciar UI
  loadRoomsList();
}


signaling.on('connect', () => {
    logMessage('[SINALIZA√á√ÉO] Conectado ao servidor.');


    // Inicializa salas com base nos dados (se 'dados' estiver pronto)
    if (dados && dados.jogos!== []) {
         initializeRoomsFromDados();
    } else {
         console.warn('[AUTO-ROOM] Vari√°vel "dados" n√£o est√° pronta, salas n√£o foram inicializadas.');
    }
    
    // Carrega a lista de salas para o dropdown
    loadRoomsList();
  });
// NOVO: Lida com a lista de peers que j√° estavam na sala
// O servidor envia isso QUANDO VOC√ä ENTRA
signaling.on('existing_peers_in_room', async ({ roomId, peerIds }) => {
  console.log(`[SIGNALING] Recebidos ${peerIds.length} peers existentes na sala ${roomId}`);

  for (const peerId of peerIds) {
    if (peerId === signaling.id) continue;

    // Se j√° temos, apenas adiciona a sala
    if (peers[peerId]) {
      peers[peerId].rooms.add(roomId);
      console.log(`[PEER] Peer ${peerId} j√° existe. Adicionando sala ${roomId}.`);
    } else {
      // Se n√£o temos, cria a conex√£o (como ofertante)
      console.log(`[PEER] Criando nova conex√£o (oferta) para ${peerId} na sala ${roomId}`);
      await createPeerConnection(peerId, true); // Cria como ofertante
      // Adiciona a sala ao rastreador (ap√≥s createPeerConnection criar o objeto)
      if (peers[peerId]) {
        peers[peerId].rooms.add(roomId);
      }
    }
  }
  // Isso substitui a necessidade do bot√£o "Call All"
 // if (callButton) callButton.disabled = true; // Desabilita o bot√£o 'Call'
  logMessage(`Conectado a ${peerIds.length} peers existentes na sala ${roomId}.`);
});
// ATUALIZADO: 'peer_joined'
signaling.on('peer_joined', async ({ peerId, roomId }) => {
  if (!peerId || peerId === signaling.id) return;

  // const roomOfEntry = getCurrentGameId(); // <-- REMOVIDO
  const roomOfEntry = roomId; // <-- CORRETO: Usa o 'roomId' do evento!
  
  logMessage(`Peer entrou na sala ${roomOfEntry}: ${peerId}`);
  console.log(`[SIGNALING] Peer joined ${peerId} (in room ${roomOfEntry})`);

  if (peers[peerId]) {
    peers[peerId].rooms.add(roomOfEntry);
    console.log(`[PEER] Peer ${peerId} j√° existe. Adicionando sala ${roomOfEntry}.`);
    return;
  }

  // Se o peer √© novo, cria a conex√£o (como n√£o-ofertante)
  await createPeerConnection(peerId, false); // Cria como n√£o-ofertante

  if (peers[peerId]) {
    peers[peerId].rooms.add(roomOfEntry);
  }
});
// ATUALIZADO: 'peer_left'
signaling.on('peer_left', ({ peerId, roomId }) => {
  if (!peerId || !peers[peerId]) return;

  // const roomOfExit = getCurrentGameId(); // <-- REMOVIDO
  const roomOfExit = roomId; // <-- CORRETO: Usa o 'roomId' do evento!

  logMessage(`Peer saiu da sala ${roomOfExit}: ${peerId}`);
  console.log(`[SIGNALING] Peer left ${peerId} (from room ${roomOfExit})`);

  // Verifica se o peer realmente estava sendo rastreado nessa sala
  if (!peers[peerId].rooms.has(roomOfExit)) {
      console.warn(`[PEER] Recebido 'peer_left' para ${peerId} da sala ${roomOfExit}, mas n√£o o rastre√°vamos l√°.`);
      return;
  }

  peers[peerId].rooms.delete(roomOfExit);

  if (peers[peerId].rooms.size === 0) {
    console.log(`[PEER] N√£o h√° mais salas em comum com ${peerId}. Fechando conex√£o.`);
    closePeerConnection(peerId);
  } else {
    console.log(`[PEER] Peer ${peerId} saiu da ${roomOfExit}, mas continua em outras salas.`);
  }
});
// Novo: Recebe lista de salas do servidor
signaling.on('rooms_list', (rooms) => {
 // console.log('[SIGNALING] Lista de salas recebida:', rooms);
  populateRoomsSelect(rooms);
});
// Recebe sinais (ofertas, answers, ICE) retransmitidos pelo servidor.
// O servidor adiciona `from` (ID do remetente).
signaling.on('signal', async (message) => {
  console.log('[SIGNALING] Sinal recebido:', message); // Log adicionado para depurar signals
  try {
    const from = message.from;
    if (!from || from === signaling.id) return; // ignora mensagens pr√≥prias

    // Adiciona check para 'to' se dispon√≠vel (para evitar processamento desnecess√°rio)
    if (message.to && message.to !== signaling.id) return;

    // Garante que exista um peer para esse `from`
    if (!peers[from]) {
      await createPeerConnection(from, false); // n√£o ofertante (receiver)
    }
    const pc = peers[from].connection;

    if (message.type === 'offer') {
      logMessage(`Offer recebido de ${from}. Criando Answer...`);
      await pc.setRemoteDescription(new RTCSessionDescription(message));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      signaling.emit('signal', { ...answer, to: from, from: signaling.id });
      console.log('[SIGNALING] Answer enviado para:', from); // Log adicionado
    } else if (message.type === 'answer') {
      logMessage(`Answer recebido de ${from}.`);
      await pc.setRemoteDescription(new RTCSessionDescription(message));
    } else if (message.type === 'candidate' && message.candidate) {
      // candidate recebido
      await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
      console.log('[ICE] Candidate adicionado de:', from); // Log adicionado
    } else {
      console.warn('Sinal desconhecido:', message);
    }
  } catch (err) {
    console.error('Erro ao processar sinal:', err);
  }
});




async function createPeerConnection(peerId, isOfferer) {
  if (peers[peerId]) {
    console.warn('Peer j√° existe:', peerId);
    return peers[peerId].connection;
  }

  console.log('[PEER] Criando conex√£o para peer:', peerId, 'isOfferer:', isOfferer);

  const pc = new RTCPeerConnection(pcConfig);
//  peers[peerId] = { connection: pc, dataChannel: null };
// LINHA CORRETA ( SUBSTITUA PELA ABAIXO):
  peers[peerId] = { connection: pc, dataChannel: null, rooms: new Set() }; // <-- ADICIONA .rooms

  pc.onicecandidate = (event) => {
    if (event.candidate) {
      signaling.emit('signal', { type: 'candidate', candidate: event.candidate, to: peerId, from: signaling.id });
    }
  };

  pc.ondatachannel = (event) => {
    const channel = event.channel;
    peers[peerId].dataChannel = channel;
    setupDataChannel(peerId, channel, 'Remoto');
    console.log('[DATACHANNEL] Canal remoto recebido de:', peerId);
  };

  pc.ontrack = (event) => {
    console.log('[TRACK] Track remoto recebido de:', peerId, event);
    let audioEl = document.getElementById(`audio_${peerId}`);
    if (!audioEl) {
      audioEl = document.createElement('audio');
      audioEl.id = `audio_${peerId}`;
      audioEl.autoplay = true;
    //  audioEl.controls = false; // Mantenha false para n√£o poluir UI
      audioEl.controls = true; // Mantenha false para n√£o poluir UI
      if (remoteContainer) remoteContainer.appendChild(audioEl);
      else document.body.appendChild(audioEl);
    }
    audioEl.srcObject = event.streams[0];
  };

  if (localStream) {
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
  }

  if (isOfferer) {
    const channel = pc.createDataChannel('chatChannel', { reliable: true });
    peers[peerId].dataChannel = channel;
    setupDataChannel(peerId, channel, 'Local');

    try {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      signaling.emit('signal', { ...offer, to: peerId, from: signaling.id });
      console.log('[SDP] Offer criada e enviada para:', peerId);
    } catch (err) {
      console.error('Erro ao criar offer', err);
    }
  }

  pc.onconnectionstatechange = () => {
    console.log('[PEER] Connection state changed:', pc.connectionState, 'para peer:', peerId);
    if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected' || pc.connectionState === 'closed') {
      closePeerConnection(peerId);
    }
  };

  return pc;
}
function closePeerConnection(peerId) {
  const peer = peers[peerId];
  if (!peer) return;
  console.log('[PEER] Fechando conex√£o para:', peerId);
  try {
    if (peer.dataChannel) peer.dataChannel.close();
    if (peer.connection) peer.connection.close();
  } catch (e) {
    console.warn('Erro fechando conex√£o:', e);
  }
  delete peers[peerId];

  const audioEl = document.getElementById(`audio_${peerId}`);
  if (audioEl && audioEl.parentNode) audioEl.parentNode.removeChild(audioEl);

  logMessage(`Conex√£o com ${peerId} encerrada.`);
}
function setupDataChannel(peerId, channel, tipo) {
  channel.onopen = () => {
    logMessage(`[${tipo}] Canal de dados com ${peerId} aberto.`);
    // Habilita UI (a l√≥gica de desabilitar fica mais complexa)
    if (sendButton) sendButton.disabled = false;
    if (messageInput) messageInput.disabled = false;
    if (sendCustomDataButton) sendCustomDataButton.disabled = false;
  };

  channel.onclose = () => {
    logMessage(`Canal de dados com ${peerId} fechado.`);
    // Se TODOS fecharem, desabilita UI
    const anyOpen = Object.values(peers).some(p => p.dataChannel && p.dataChannel.readyState === 'open');
    if (!anyOpen) {
      if (sendButton) sendButton.disabled = true;
      if (messageInput) messageInput.disabled = true;
      if (sendCustomDataButton) sendCustomDataButton.disabled = true;
    }
  };

  channel.onerror = (err) => {
    console.error('DataChannel error', err);
  };

  channel.onmessage = (event) => {
    console.log('[DATACHANNEL] Mensagem recebida de:', peerId, event.data);
    let parsed;
    try {
      parsed = JSON.parse(event.data);
    } catch {
      parsed = null;
    }

    if (!parsed) {
        // Mensagem de texto puro (sem JSON)
        displayMessage(peerId, event.data);
        return;
    }

    // L√ìGICA DE SINCRONIZA√á√ÉO DE DADOS (J√° est√° correta)
    if (parsed.type === 'sync_data') {
      const payload = parsed.payload || {};
      const gameId = parsed.gameId; // Usa o gameId da mensagem
      if (gameId && parsed.version > (dados.version || 0)) {
        // ... (sua l√≥gica de sync de dados) ...
        dados.version = parsed.version || Date.now();
        // salvarDados(); // Chame sua fun√ß√£o de salvar
        logMessage(`[LOG] Sincroniza√ß√£o recebida do peer ${peerId} (Jogo ${gameId}).`);
      }
      return;
    }

    // L√ìGICA DE CHAT MULTI-SALA
    if (parsed.roomId) {
        // S√ì EXIBE A MENSAGEM SE FOR DA SALA ATIVA (EM FOCO)
        if (parsed.roomId === getCurrentGameId()) {
            displayMessage(parsed.sender || peerId, parsed.text);
        } else {
            // Mensagem de outra sala. N√£o exibe, mas loga.
            console.log(`[CHAT] Mensagem recebida de ${peerId} na sala ${parsed.roomId} (n√£o exibida, sala inativa)`);
            // (Aqui voc√™ poderia adicionar um indicador de "nova mensagem" em outra sala)
        }
    } else if (parsed.sender && parsed.text) {
        // Fallback: Mensagem sem roomId (exibe na sala atual)
        displayMessage(parsed.sender, parsed.text);
    }
  };
}
async function start() {
  if (startButton) startButton.disabled = true;
  console.log('[AUDIO] Iniciando getUserMedia...');
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    localStream = stream;

    if (localVideo) {
      localVideo.srcObject = stream;
      localVideo.muted = true;
    }

    // Adiciona tracks locais a TODAS as conex√µes P2P existentes
    for (const peerId in peers) {
      const pc = peers[peerId].connection;
      try {
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        // Renegocia (opcional, mas recomendado se a track foi adicionada depois)
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        signaling.emit('signal', { ...offer, to: peerId, from: signaling.id });
      } catch (e) {
        console.warn('Erro adicionando track e renegociando', e);
      }
    }

  //  if (callButton) callButton.disabled = false;
   // if (hangupButton) hangupButton.disabled = false;
    logMessage('Microfone ativado.');
  } catch (e) {
    console.error('getUserMedia erro:', e);
    alert('Erro ao acessar o microfone: ' + (e.message || e.name));
    if (startButton) startButton.disabled = false;
  }
}
// Quando usu√°rio quer iniciar ofertas para todos (√∫til se j√° houver peers)
async function callAll() {
  console.log('[CALL] Iniciando callAll para peers (na sala atual):', currentGameId);

  
  const peerIds = Object.keys(peers);
  for (const peerId of peerIds) {
    const peer = peers[peerId];
    if (!peer) continue;
    if (peer.dataChannel && peer.dataChannel.readyState === 'open') continue;
    
    // (Aten√ß√£o: Esta l√≥gica ainda tentar√° ligar para TODOS)
    // Uma l√≥gica melhor seria filtrar peers por sala (exigiria mudan√ßa no 'peers')
    
    try {
      await createPeerConnection(peerId, true); // Tenta ser o Ofertante
    } catch (e) {
      console.warn('Erro criando offer para', peerId, e);
    }
  }
}
function sendMessage() {
  const text = messageInput ? messageInput.value.trim() : '';
  if (!text) return;
  
  // 1. Adiciona a tag da sala atual
  const message = { 
    sender: 'Voc√™', 
    text, 
    timestamp: Date.now(),
    roomId: getCurrentGameId() // <-- MUDAN√áA IMPORTANTE
  };

  console.log('[CHAT] Enviando mensagem:', message);

  // 2. Envia para TODOS os peers (de todas as salas)
  // O receptor (em setupDataChannel) ir√° filtrar quais exibir.
  Object.entries(peers).forEach(([peerId, { dataChannel }]) => {
    if (dataChannel && dataChannel.readyState === 'open') {
      try {
        dataChannel.send(JSON.stringify(message));
      } catch (e) {
        console.warn('Erro ao enviar mensagem para peer ' + peerId, e);
      }
    }
  });

  // 3. Salva localmente (sua fun√ß√£o salvarDados deve usar o 'jogoId' / 'roomId')
  if (!dados.chats) dados.chats = [];
  dados.chats.push({ 
      sender: 'Voc√™', 
      content: text, 
      jogoId: getCurrentGameId(), // Assumindo que 'jogoId' √© o 'roomId'
      timestamp: Date.now() 
  });
   salvarDados(); // Chame sua fun√ß√£o de salvar

  // 4. Exibe localmente
  displayMessage('Voc√™', text);
  if (messageInput) messageInput.value = '';
}
function sendDataChannelObjectToAll(obj) {
  const json = JSON.stringify(obj);
  console.log('[SYNC] Enviando objeto sync:', obj);
  Object.entries(peers).forEach(([peerId, { dataChannel }]) => {
    if (dataChannel && dataChannel.readyState === 'open') {
      try {
        dataChannel.send(json);
      } catch (e) {
        console.warn('Erro ao enviar objeto para peer ' + peerId, e);
      }
    }
  });
}
// Fun√ß√£o chamada pelo bot√£o "Enviar Objeto Customizado"
function sendCustomData() {
  // ... (Sua l√≥gica de adicionar usu√°rio, etc.) ...
    // exemplo: adiciona usu√°rio e sincroniza
  const newUserId = (dados.usuarios && dados.usuarios.length) ? dados.usuarios.length + 1 : 1;
  if (!dados.usuarios) dados.usuarios = [];
  const newUser = { id: newUserId, usuario: `peer_sync_${newUserId}`, role: 'sincronizado', timestamp: Date.now() };
  dados.usuarios.push(newUser);
  salvarDados();
  
  // cria payload filtrado e envia como 'sync_data'
  const payload = getFilteredDataByGameId(getCurrentGameId());
  const syncObject = { 
      type: 'sync_data', 
      payload: payload, 
      version: Date.now(), 
      gameId: getCurrentGameId() // Correto!
  };
  sendDataChannelObjectToAll(syncObject);

  displayMessage('Voc√™ (Sistema)', `Simula√ß√£o de dados sincronizada para sala ${getCurrentGameId()}.`);
}
function displayMessage(sender, text) {
  if (!messagesDiv) {
    console.log(`${sender}: ${text}`);
    return;
  }
  const messageElement = document.createElement('p');
  messageElement.innerHTML = `<strong>${sender}:</strong> ${text}`;
  messagesDiv.appendChild(messageElement);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
function logMessage(text) {
  if (!messagesDiv) {
    console.log('[LOG]', text);
    return;
  }
  const logElement = document.createElement('p');
  logElement.style.fontStyle = 'italic';
  logElement.style.fontSize = '0.8em';
  logElement.textContent = `[LOG] ${text}`;
  messagesDiv.appendChild(logElement);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
function getFilteredDataByGameId(gameId) {
  if (!gameId) return dados;
  const filteredPayload = {
    usuarios: (dados.usuarios || []).filter(u => u.jogoId === gameId || u.jogoId === undefined),
    apostasUsuarios: (dados.apostasUsuarios || []).filter(a => a.jogoId === gameId),
    desafiosUsuarios: (dados.desafiosUsuarios || []).filter(d => d.jogoId === gameId),
    chats: (dados.chats || []).filter(c => c.jogoId === gameId),
    jogos: (dados.jogos || []).filter(j => j.id === gameId),
    transacoes: dados.transacoes || []
  };
  return filteredPayload;
}
function syncDataToPeers() {
   salvarDados(); // Salva local

  const gameId = getCurrentGameId();
  const filteredPayload = getFilteredDataByGameId(gameId);
  const syncObject = { type: 'sync_data', payload: filteredPayload, version: Date.now(), gameId: gameId };
  sendDataChannelObjectToAll(syncObject);
  logMessage(`[LOG] Dados do Jogo ${gameId} sincronizados com peers.`);
}
// Carrega lista de salas (emita evento para servidor buscar lista)
function loadRoomsList() {
  signaling.emit('get_rooms_list'); // Servidor responde com 'rooms_list'
}
// Popula select com salas
function populateRoomsSelect(rooms) {
  if (!roomsSelect) return;
  roomsSelect.innerHTML = '';
  rooms.forEach(room => {
    const option = document.createElement('option');
    option.value = room;
    option.textContent = room;
    if (room === currentGameId) option.selected = true;
    roomsSelect.appendChild(option);
  });
}
// Join na sala selecionada (troca de sala)
function joinSelectedRoom() {
  const newGameId = roomsSelect.value;
  if (!newGameId || newGameId === currentGameId) return;

  // [MUDAN√áA IMPORTANTE]
  // REMOVIDO: hangupAll(); 
  // N√£o desconectamos mais, apenas trocamos o foco.

  // 1. Atualiza a sala em foco
  currentGameId = newGameId;
  joinedRooms.add(newGameId); // <-- ADICIONE ISSO
  
  // 2. Informa ao servidor que entramos nesta sala
  // (O servidor saber√° que j√° estamos nela ou nos adicionar√°)
  signaling.emit('join_room', currentGameId);
  
  logMessage(`[SINALIZA√á√ÉO] Foco trocado para sala: ${currentGameId}`);

  // 3. Limpar o chat local (opcional, mas recomendado)
  if (messagesDiv) messagesDiv.innerHTML = '';
  logMessage(`Exibindo chat da sala: ${currentGameId}`);
  
  // 4. (Opcional) Recarregar dados/chat da nova sala
  // syncDataToPeers(); // Cuidado para n√£o causar loop
}
// Nova fun√ß√£o para lidar com cria√ß√£o de sala
function handleCreateRoom() {
  const gameName = prompt('Digite o nome do jogo para gerar o nome da sala:');
  if (!gameName) return;

  let proposedRoomName = `${gameName.toLowerCase().replace(/\s/g, '-')}-room`;

  signaling.emit('check_room_exists', proposedRoomName, (exists) => {
    if (exists) {
      alert(`Sala "${proposedRoomName}" j√° existe. Apenas entre nela.`);
      // Opcional: troca automaticamente para ela
      // roomsSelect.value = proposedRoomName;
      // joinSelectedRoom();
    } else {
      signaling.emit('create_room', proposedRoomName);
      currentGameId = proposedRoomName; // Foco na nova sala
      joinedRooms.add(proposedRoomName); // <-- ADICIONE ISSO
      signaling.emit('join_room', proposedRoomName); // Join na nova sala
      logMessage(`[SINALIZA√á√ÉO] Sala "${proposedRoomName}" criada e entrada.`);
      loadRoomsList(); // Atualizar lista de salas
    }
  });
}
function escapeStringForHTML(str) {
    if (!str) return '';
    return str.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}
function abrirChatParaItem(itemType, itemId, itemName) {
    // 1. Gerar nome da sala usando o NOME ao inv√©s do ID
    const safeName = itemName ? itemName.toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]/g, '') : 'default';
    const roomName = `${itemType}-${safeName}`;

    // 2. Checar/Criar e Entrar na sala nova
    signaling.emit('check_room_exists', roomName, (exists) => {
        if (!exists) {
            signaling.emit('create_room', roomName);
            logMessage(`[SINALIZA√á√ÉO] Sala autom√°tica "${roomName}" criada para ${itemType}.`);
        }
        currentGameId = roomName; // Define o foco
        joinedRooms.add(roomName);
        signaling.emit('join_room', roomName);
        logMessage(`[SINALIZA√á√ÉO] Entrou na sala autom√°tica: ${roomName}`);
        
        // 3. Atualizar a lista de salas
        loadRoomsList(); 
        
        // 4. Abrir o modal se n√£o estiver aberto
        if (!chatModalAberto) {
            abrirChatModal();
        }
    });
}
// Esta fun√ß√£o APENAS constr√≥i o HTML do modal e o exibe
function abrirChatModal() {
  if (chatModalAberto) return;

  chatModalElement = document.createElement('div');
  chatModalElement.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5); z-index: 10000; display: flex;
    justify-content: center; align-items: center;
  `;

  const modalContent = document.createElement('div');
  modalContent.style.cssText = `
    background: white; padding: 20px; border-radius: 10px;
    width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative;
  `;

  const closeButton = document.createElement('button');
  closeButton.textContent = '√ó';
  closeButton.style.cssText = `position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #666;`;
  closeButton.onclick = fecharChatModal;

  const chatHTML = `
    <div id="container">
      <h1>WebRTC Voice & Text Chat</h1>
      <p>Comunica√ß√£o P2P. Sala atual (foco): <span id="currentRoomDisplay">${currentGameId}</span></p>
      <div id="roomsContainer" style="margin-bottom: 10px;">
        <label for="roomsSelect">Salas dispon√≠veis:</label>
        <select id="roomsSelect"></select>
<button id="joinRoomButton">Trocar Foco</button>
<button id="createRoomButton">Criar Nova Sala</button>
<button id="leaveRoomButton" style="background-color: #f44336; color: white;">Sair da Sala Atual</button>
</button>
      </div>

<div id="usuariosContainer" style="margin-bottom: 10px;">
  <label for="usuariosSelect">Usu√°rios conectados:</label>
  <select id="usuariosSelect">
    <option value="">Selecione um usu√°rio</option>
  </select>
  <button id="verPerfilUsuarioButton" style="background-color: #4CAF50; color: white;">Ver Perfil</button>
</div>

      <div id="video-streams">
        <audio id="localVideo" playsinline autoplay muted style="display:none;"></audio>
        <div id="remoteContainer"></div>
      </div>
      <div class="box">
        <button id="startButton">Start (Obter √Åudio)</button>
      <!--
        <button id="callButton">Call (Renegociar)</button>
      <button id="hangupButton">Hang Up (Sair de TUDO)</button>
      -->
      </div>
      <div id="chatContainer">
        <h3>Chat de Texto P2P (Sala: ${currentGameId})</h3>
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="Digite sua mensagem..." disabled>
        <div style="display: flex; gap: 10px; margin-top: 5px;">
          <button id="sendButton" disabled style="flex-grow: 1;">Enviar Texto</button>
          <button id="sendCustomDataButton" disabled style="flex-grow: 1;">Sync Dados (Sala Atual)</button>
        </div>
      </div>
      <p>Verifique o console para logs.</p>
    </div>
  `;
  modalContent.innerHTML = chatHTML;
  modalContent.appendChild(closeButton);
  chatModalElement.appendChild(modalContent);
  document.body.appendChild(chatModalElement);
  chatModalAberto = true;

  console.log('[MODAL] Modal de chat aberto');

  // inicializa elementos e listeners
  setTimeout(() => {
    initChatUI();
    // <<< FIM DO BLOCO >>>
    // Atualiza a lista de salas no dropdown
    loadRoomsList(); 
    // Atualiza o <select> para garantir que a sala atual esteja selecionada
    if (roomsSelect) roomsSelect.value = currentGameId;
  }, 50);


// Preenche o select com os usu√°rios do sistema
const usuariosSelect = modalContent.querySelector("#usuariosSelect");
const verPerfilUsuarioButton = modalContent.querySelector("#verPerfilUsuarioButton");

if (usuariosSelect && dados.usuarios && dados.usuarios.length > 0) {
  dados.usuarios.forEach(u => {
    const opt = document.createElement("option");
    opt.value = u.usuario;
    opt.textContent = u.nome || u.usuario;
    usuariosSelect.appendChild(opt);
  });
}

if (verPerfilUsuarioButton) {
  verPerfilUsuarioButton.addEventListener("click", () => {
    const usuarioSelecionado = usuariosSelect.value;
    if (!usuarioSelecionado) {
      alert("Selecione um usu√°rio para ver o perfil.");
      return;
    }
    abrirModalPerfilUsuario(usuarioSelecionado);
  });
}


// === BLOCO DE SELECTS GEN√âRICOS (ocult√°vel) ===
const toggleBtn = document.createElement("button");
toggleBtn.id = "toggleSelectsButton";
toggleBtn.textContent = "‚ñæ Ocultar Seletores";
toggleBtn.style.cssText = `
  background: #333; color: white; border: none;
  border-radius: 5px; padding: 6px 10px; cursor: pointer;
  width: 100%; margin-top: 10px; margin-bottom: 5px;
`;
toggleBtn.onclick = toggleSelectsContainer;

const selectsContainer = document.createElement("div");
selectsContainer.id = "selectsContainer";
selectsContainer.style.cssText = `
  margin-top: 5px;
  display: block;
  transition: all 0.3s ease;
`;

// Adiciona os selects dentro do container
selectsContainer.appendChild(criarSelectGenerico("jogo", dados.jogos, { nome: "nome" }));
selectsContainer.appendChild(criarSelectGenerico("aposta", dados.apostasUsuarios, { nome: "titulo" }));
selectsContainer.appendChild(criarSelectGenerico("desafio", dados.desafiosUsuarios, { nome: "titulo" }));
selectsContainer.appendChild(criarSelectGenerico("chat", dados.chats, { nome: "cardId" }));

// Adiciona o bot√£o e o container ao modal
modalContent.appendChild(toggleBtn);
modalContent.appendChild(selectsContainer);

modalContent.appendChild(selectsContainer);


  // fecha modal ao clicar fora
  chatModalElement.onclick = function(e) {
    if (e.target === chatModalElement) fecharChatModal();
  };
}
function abrirModalPerfilUsuario(usuarioIdOuNome) {
  const usuario = dados.usuarios.find(
    u => u.usuario === usuarioIdOuNome || u.nome === usuarioIdOuNome
  );
  if (!usuario) {
    alert("Usu√°rio n√£o encontrado!");
    return;
  }

  const modal = document.createElement("div");
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: flex; justify-content: center;
    align-items: center; z-index: 10001;
  `;

  const content = document.createElement("div");
  content.style.cssText = `
    background: white; border-radius: 10px; padding: 20px;
    width: 300px; max-width: 90%;
  `;

  content.innerHTML = `
    <h2>${usuario.nome}</h2>
    <img src="${usuario.imagem || 'default-usuario.png'}" 
         alt="${usuario.nome}" 
         style="width:100px; height:100px; border-radius:50%; object-fit:cover; margin-bottom:10px;">
    <p><strong>Usu√°rio:</strong> ${usuario.usuario}</p>
    <p><strong>M√©rito:</strong> ${usuario.merito || 0}</p>
    <p><strong>Desafios cumpridos:</strong> ${usuario.desafiosCumpridos || 0}</p>
    <p><strong>Pagamentos realizados:</strong> ${usuario.pagamentosRealizados || 0}</p>
    <p><strong>Amigos:</strong> ${(usuario.amigos && usuario.amigos.length) || 0}</p>
    <button id="fecharPerfilModal" style="margin-top:10px;">Fechar</button>
  `;

  modal.appendChild(content);
  document.body.appendChild(modal);

  modal.querySelector("#fecharPerfilModal").onclick = () => modal.remove();
  modal.onclick = e => { if (e.target === modal) modal.remove(); };
}
function criarSelectGenerico(tipo, lista, campos = {}) {
  const container = document.createElement("div");
  container.style.marginBottom = "10px";

  const label = document.createElement("label");
  label.textContent = `Selecionar ${tipo}:`;
  label.style.display = "block";
  label.style.marginBottom = "5px";

  const select = document.createElement("select");
  select.id = `select-${tipo}`;
  select.style.width = "100%";
  select.innerHTML = `<option value="">Selecione um ${tipo}</option>`;

  if (lista && lista.length > 0) {
    console.log("____________lista",lista)
    lista.forEach(item => {
      const opt = document.createElement("option");
      opt.value = item.id || item.cardId || item.usuario || item.nome || item.titulo || "";
      opt.textContent = item[campos.nome] || item.nome || item.titulo || item.usuario || `(${tipo} sem nome)`;
      select.appendChild(opt);
    });
  } else {
    const opt = document.createElement("option");
    opt.textContent = "Nenhum dispon√≠vel";
    select.appendChild(opt);
  }

  const button = document.createElement("button");
  button.textContent = `Ver ${tipo}`;
  button.style.cssText = `
    background-color: #4CAF50; color: white; margin-top: 5px; width: 100%;
    border: none; border-radius: 5px; padding: 8px; cursor: pointer;
  `;

  button.addEventListener("click", () => {
    const valor = select.value;
    if (!valor) {
      alert(`Selecione um ${tipo} para ver detalhes`);
      return;
    }
  abrirModalGenerico(tipo, valor);
  });

  container.appendChild(label);
  container.appendChild(select);
  container.appendChild(button);
  return container;
}
function abrirModalGenerico(tipo, idOuNome) {
  let item = null;
  switch (tipo) {
    case "usuario":
      item = dados.usuarios.find(u => u.usuario === idOuNome || u.nome === idOuNome);
      break;
    case "jogo":
      item = dados.jogos.find(j => j.id == idOuNome || j.nome === idOuNome || j.titulo === idOuNome);
      break;
    case "aposta":
      item = dados.apostasUsuarios.find(a => a.id == idOuNome || a.cardId === idOuNome);
      break;
    case "desafio":
      item = dados.desafiosUsuarios.find(d => d.id == idOuNome || d.cardId === idOuNome);
      break;
    case "chat":
      item = dados.chats.find(c => c.cardId === idOuNome);
      break;
  }

  if (!item) {
    alert(`${tipo} n√£o encontrado!`);
    return;
  }

  const modal = document.createElement("div");
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); display: flex; justify-content: center;
    align-items: center; z-index: 11000;
  `;

  const content = document.createElement("div");
  content.style.cssText = `
    background: white; border-radius: 10px; padding: 20px;
    width: 400px; max-width: 90%; max-height: 80%; overflow-y: auto;
  `;

  const titulo = item.nome || item.titulo || tipo.toUpperCase();
  content.innerHTML = `
    <h2>${titulo}</h2>
    <pre style="background:#f4f4f4; padding:10px; border-radius:5px; overflow-x:auto;">${JSON.stringify(item, null, 2)}</pre>
    <button style="margin-top:10px;" id="fechar-${tipo}-modal">Fechar</button>
  `;

  modal.appendChild(content);
  document.body.appendChild(modal);
  document.getElementById(`fechar-${tipo}-modal`).onclick = () => modal.remove();
  modal.onclick = e => { if (e.target === modal) modal.remove(); };
}
function toggleSelectsContainer() {
  const container = document.getElementById("selectsContainer");
  const btn = document.getElementById("toggleSelectsButton");

  const isVisible = container.style.display === "block";
  container.style.display = isVisible ? "none" : "block";
  btn.innerHTML = isVisible ? "‚ñ∏ Mostrar Seletores" : "‚ñæ Ocultar Seletores";
}
function criarSelectApostas() {
  const container = document.createElement("div");
  container.style.marginBottom = "10px";

  const label = document.createElement("label");
  label.textContent = "Selecionar Aposta:";
  label.style.display = "block";
  label.style.marginBottom = "5px";

  const select = document.createElement("select");
  select.id = "select-aposta";
  select.style.width = "100%";
  select.innerHTML = `<option value="">Selecione uma aposta</option>`;

  if (dados.apostasUsuarios && dados.apostasUsuarios.length > 0) {
    dados.apostasUsuarios.forEach(ap => {
      const opt = document.createElement("option");
      opt.value = ap.id;
      opt.textContent = `${ap.titulo} (${ap.status})`;
      select.appendChild(opt);
    });
  } else {
    const opt = document.createElement("option");
    opt.textContent = "Nenhuma aposta dispon√≠vel";
    select.appendChild(opt);
  }

  const button = document.createElement("button");
  button.textContent = "Ver Detalhes da Aposta";
  button.style.cssText = `
    background-color: #4CAF50; color: white; margin-top: 5px;
    border: none; border-radius: 5px; padding: 8px; cursor: pointer;
    width: 100%;
  `;

  button.addEventListener("click", () => {
    const apostaId = select.value;
    if (!apostaId) {
      alert("Selecione uma aposta para ver detalhes");
      return;
    }
  //  abrirModalApostaDetalhada(apostaId);
  });

  container.appendChild(label);
  container.appendChild(select);
  container.appendChild(button);
  return container;
}
function fecharChatModal() {
  if (chatModalElement && chatModalAberto) {
    // ATEN√á√ÉO: N√ÉO damos hangupAll() ao fechar o modal.
    // As conex√µes de √°udio e dados continuam ativas em segundo plano.
    // O usu√°rio s√≥ desconecta se clicar em "Hang Up (Sair de TUDO)".
    
    document.body.removeChild(chatModalElement);
    chatModalElement = null;
    chatModalAberto = false;
    console.log('[MODAL] Modal fechado. Conex√µes permanecem ativas.');
  }
}
function getCurrentGameId() {
  // 'currentGameId' agora √© a vari√°vel de estado principal
  return currentGameId || 'default_room';
}
// Fun√ß√£o para inicializar salas automaticamente para todos os items em dados
// Em index.html
function initializeRoomsFromDados() {
  

    function processItems(items, type, parentPrefix = '') {
        if (!items || !Array.isArray(items)) return;
        
        items.forEach(item => {
            
            // 1. Gerar o nome/ID local deste item
            let itemLocalName = null;
            if (item.id) {
                itemLocalName = `${type}-${item.id}`;
            } else if (item.nome) {
                itemLocalName = `${type}-${item.nome.toLowerCase().replace(/\s/g, '-')}`;
            } else if (item.titulo) {
                itemLocalName = `${type}-${item.titulo.toLowerCase().replace(/\s/g, '-')}`;
            } 
            // Fallback para tipos que usam 'cardId' como identificador principal
            else if ((type === 'aposta' || type === 'desafio' || type === 'chat') && item.cardId) {
                itemLocalName = `${type}-${item.cardId}`;
            }

            // Se n√£o conseguirmos um ID, n√£o podemos criar uma sala para este item.
            // Mas ainda podemos processar seus filhos, usando o prefixo do pai (av√¥).
            if (!itemLocalName) {
                console.warn(`[AUTO-ROOM] Item do tipo '${type}' n√£o tem id/nome/t√≠tulo/cardId. Pulando cria√ß√£o de sala, mas processando filhos (se houver).`);
                // Processa filhos mesmo se o pai n√£o puder ter uma sala
                processChildren(item, parentPrefix);
                return; // Pula para o pr√≥ximo item
            }

            // 2. Gerar o nome da sala HIER√ÅRQUICA
            // Se parentPrefix existir, concatena; sen√£o, usa s√≥ o nome local.
            const roomName = parentPrefix ? `${parentPrefix}:${itemLocalName}` : itemLocalName;

            // 3. Enviar para o servidor verificar e criar
            signaling.emit('check_room_exists', roomName, (exists) => {
                if (!exists) {
                    signaling.emit('create_room', roomName);
                    // Log mais claro da hierarquia
                    console.log(`[AUTO-ROOM-H] Sala criada: ${roomName}`);
                }
            });
            
            // 4. Processar filhos, passando o NOVO prefixo (roomName)
            processChildren(item, roomName);
        });
    }


    function processChildren(item, newPrefix) {
        if (item.estadios) processItems(item.estadios, 'estadio', newPrefix);
        if (item.times) processItems(item.times, 'time', newPrefix);
        if (item.lives) processItems(item.lives, 'live', newPrefix);
        if (item.divsHorizontais) processItems(item.divsHorizontais, 'divH', newPrefix);
        if (item.cards) processItems(item.cards, 'card', newPrefix);
        if(item){
          
       // console.log("______item",item)
        }
        // Adicione mais tipos de sub-itens aqui se necess√°rio
    }

    // 5. Inicia processamento para TODAS as chaves raiz em 'dados'
    console.log("[AUTO-ROOM-H] Iniciando varredura hier√°rquica de 'dados'...");
    
    // Estrutura hier√°rquica principal (filhos ser√£o processados recursivamente)
    if (dados.jogos && dados.jogos !== []) {
        processItems(dados.jogos, 'jogo');
      
        
    }
    
    // Outras estruturas de topo (flat) - sem filhos
    if (dados.usuarios) {
        processItems(dados.usuarios, 'usuario');
    }
    if (dados.apostasUsuarios) {
        processItems(dados.apostasUsuarios, 'aposta');
    }
    if (dados.desafiosUsuarios) {
        processItems(dados.desafiosUsuarios, 'desafio');
    }
    if (dados.chats) {
        processItems(dados.chats, 'chat');
    }
    // 'transacoes' provavelmente n√£o precisa de salas individuais

    // 6. Atualiza lista de salas ap√≥s cria√ß√£o (aumentei o delay)
    // Damos mais tempo para o servidor processar o volume maior de checagens.
    setTimeout(loadRoomsList, 3500); 
}
function leaveIndividualRoom(roomId) {
  if (!roomId || roomId === 'default_room') {
    console.warn('N√£o √© poss√≠vel sair da sala padr√£o.');
    return;
  }

  if (!joinedRooms.has(roomId)) {
    console.warn(`Voc√™ n√£o est√° (ou n√£o deveria estar) na sala ${roomId}.`);
    return;
  }

  console.log(`[LEAVE] Iniciando sa√≠da da sala: ${roomId}`);
  logMessage(`Saindo da sala ${roomId}...`);

  // 1. Informa ao servidor que estamos saindo
  // (Voc√™ PRECISAR√Å implementar o listener 'leave_room' no seu servidor)
  signaling.emit('leave_room', roomId);
  joinedRooms.delete(roomId);

  // 2. Itera sobre todos os peers
  for (const peerId in peers) {
    const peer = peers[peerId];
    // Verifica se compartilh√°vamos esta sala com o peer
    if (peer.rooms.has(roomId)) {
      
      peer.rooms.delete(roomId); // Remove a sala do rastreador do peer

      // 3. Se essa era a √öLTIMA sala em comum, desconecta
      if (peer.rooms.size === 0) {
        logMessage(`Desconectando de ${peerId} (√∫ltima sala em comum era ${roomId}).`);
        closePeerConnection(peerId);
      } else {
        logMessage(`Saindo de ${roomId}, mas ainda conectado a ${peerId} (via outras salas).`);
      }
    }
  }

  // 4. Atualiza a UI
  loadRoomsList(); // Pede ao servidor a nova lista de salas (a sala pode ter sumido)

  // 5. Se sa√≠mos da sala que estava em foco, move o foco para 'default_room'
  if (currentGameId === roomId) {
    currentGameId = 'default_room';
    if (roomsSelect) roomsSelect.value = 'default_room';
    if (messagesDiv) messagesDiv.innerHTML = '';
    logMessage(`Foco movido para a sala ${currentGameId}.`);
    // (Pode ser necess√°rio chamar 'joinSelectedRoom' ou 'join_room' para default)
    signaling.emit('join_room', 'default_room');
  }
}
// Se desejar abrir o modal automaticamente:
 // abrirChatModal();


/////
/////
function toggleEstadioBotoes(estadioId) {
    const container = document.getElementById(`botoes-estadio-${estadioId}`);
    const btn = document.getElementById(`toggle-${estadioId}`);
    const expanded = container.style.display === 'flex';
    container.style.display = expanded ? 'none' : 'flex';
    btn.innerHTML = expanded ? '+' : '‚àí';
}
function toggleTimeBotoes(timeId) {
    const container = document.getElementById(`botoes-time-${timeId}`);
    const btn = document.getElementById(`toggle-time-${timeId}`);
    const expanded = container.style.display === 'flex';
    container.style.display = expanded ? 'none' : 'flex';
    btn.innerHTML = expanded ? '+' : '‚àí';
}
function toggleLiveBotoes(liveId) {
    const container = document.getElementById(`botoes-live-${liveId}`);
    const btn = document.getElementById(`toggle-live-${liveId}`);
    const expanded = container.style.display === 'flex';
    
    container.style.display = expanded ? 'none' : 'flex';
    btn.innerHTML = expanded ? '+' : '‚àí';
    toggleStatesLive[liveId] = !expanded;
}
// === FUN√á√ïES DE TOGGLE ===
function toggleDivBotoes(divId) {
    toggleStates.divs[divId] = !toggleStates.divs[divId];
    const container = document.getElementById(`botoes-div-${divId}`);
    const btn = document.getElementById(`toggle-div-${divId}`);
    
    if (container && btn) {
        container.style.display = toggleStates.divs[divId] ? 'flex' : 'none';
        btn.innerHTML = toggleStates.divs[divId] ? '‚àí' : '+';
    }
}
function toggleScrollContainerBotoes(divId) {
    toggleStates.scrollContainers[divId] = !toggleStates.scrollContainers[divId];
    const container = document.getElementById(`botoes-scroll-${divId}`);
    const btn = document.getElementById(`toggle-scroll-${divId}`);
    
    if (container && btn) {
        container.style.display = toggleStates.scrollContainers[divId] ? 'flex' : 'none';
        btn.innerHTML = toggleStates.scrollContainers[divId] ? '‚àí' : '+';
    }
}
function toggleIframerBotoes(cardId) {
    toggleStates.iframers[cardId] = !toggleStates.iframers[cardId];
    const container = document.getElementById(`botoes-iframer-${cardId}`);
    const btn = document.getElementById(`toggle-iframer-${cardId}`);
    
    if (container && btn) {
        container.style.display = toggleStates.iframers[cardId] ? 'flex' : 'none';
        btn.innerHTML = toggleStates.iframers[cardId] ? '‚àí' : '+';
    }
}

/////
/////



////////////
////////////
////////////
////////////



// Fun√ß√£o para encontrar live
function encontrarLive(jogoId, estadioId, timeId, liveId) {
    const jogo = dados.jogos.find(j => j.id === jogoId);
    if (!jogo) return null;
    
    const estadio = jogo.estadios.find(e => e.id === estadioId);
    if (!estadio) return null;
    
    const time = estadio.times.find(t => t.id === timeId);
    if (!time || !time.lives) return null;
    
    return time.lives.find(l => l.id === liveId);
}
// Fun√ß√£o para encontrar streamer
function encontrarStreamer(jogoId, estadioId, timeId, liveId, streamerId) {
    const live = encontrarLive(jogoId, estadioId, timeId, liveId);
    if (!live || !live.streamers) return null;
    
    return live.streamers.find(s => s.id === streamerId);
}
// Fun√ß√£o para ver streamers de uma live
function verStreamersDaLive(jogoId, estadioId, timeId, liveId) {
    const live = encontrarLive(jogoId, estadioId, timeId, liveId);
    if (!live) {
        alert("Live n√£o encontrada!");
        return;
    }
    
    mostrarSecao('streamers');
    carregarStreamersDaLive(jogoId, estadioId, timeId, liveId);
}
// Fun√ß√£o para mostrar se√ß√£o
function mostrarSecao(secao) {
    // Esconder todas as se√ß√µes
    document.querySelectorAll('.secao').forEach(sec => {
        sec.style.display = 'none';
    });
    
    // Mostrar a se√ß√£o desejada
    document.getElementById(`secao-${secao}`).style.display = 'block';
}
// Fun√ß√£o para voltar para jogos
function voltarParaJogos() {
    mostrarSecao('jogos');
}
// Fun√ß√£o para voltar para est√°dios
function voltarParaEstadios() {
    mostrarSecao('estadios');
}
// Fun√ß√£o para voltar para times
function voltarParaTimes() {
    mostrarSecao('times');
}
// Fun√ß√£o para voltar para lives
function voltarParaLives() {
    mostrarSecao('lives');
}
// FUN√á√ïES DE VOZ PARA LIVE
//////////// navegacao
//////////// navegacao
//////////// navegacao
//////////// navegacao
//////////// navegacao
//////////// navegacao
// Fun√ß√µes de navega√ß√£o
function mostrarSecao(secao) {
    document.querySelectorAll('.secao').forEach(el => {
        el.style.display = 'none';
    });
    document.getElementById(`secao-${secao}`).style.display = 'block';
    
    // S√≥ carrega automaticamente as se√ß√µes que n√£o precisam de par√¢metros
    if (secao === 'jogos' || secao === 'estadios' || secao === 'times') {
        carregarSecao(secao);
    }
}
// Fun√ß√£o para carregar dados da se√ß√£o
async function carregarSecao(secao) {
    switch(secao) {
        case 'jogos':
        await    carregarJogos();
            break;
        case 'estadios':
            if (jogoSelecionadoId) {
              await  carregarEstadiosDoJogo(jogoSelecionadoId);
            } else {
             await   carregarEstadios();
            }
            break;
        case 'times':
            if (jogoSelecionadoId && await estadioSelecionadoId) {
                carregarTimesDoEstadio(jogoSelecionadoId, estadioSelecionadoId);
            } else {
             await   carregarTimes();
            }
            break;
        case 'lives':
            if (jogoSelecionadoId && estadioSelecionadoId && timeSelecionadoId) {
                carregarLivesDoTime(jogoSelecionadoId, estadioSelecionadoId, timeSelecionadoId);
            }
            break;
        case 'streamers':
            if (jogoSelecionadoId && estadioSelecionadoId && timeSelecionadoId && liveSelecionadoId) {
                carregarStreamersDaLive(jogoSelecionadoId, estadioSelecionadoId, timeSelecionadoId, liveSelecionadoId);
            }
            break;
    }
}
// Fun√ß√µes para voltar - MANTENDO OS IDs SELECIONADOS
function voltarParaJogos() {
    mostrarSecao('jogos');
    // N√£o limpa jogoSelecionadoId para manter contexto
}
function voltarParaEstadios() {
    mostrarSecao('estadios');
    // N√£o limpa estadioSelecionadoId para manter contexto
}
function voltarParaTimes() {
    mostrarSecao('times');
    // N√£o limpa timeSelecionadoId para manter contexto
}
function voltarParaLives() {
    mostrarSecao('lives');
    // N√£o limpa liveSelecionadoId para manter contexto
}
function verEstadiosDoJogo(jogoId) {
    jogoSelecionadoId = jogoId;
    mostrarSecao('estadios');
}
function verTimesDoEstadio(jogoId, estadioId) {
    jogoSelecionadoId = jogoId;
    estadioSelecionadoId = estadioId;
    mostrarSecao('times');
}
function verLivesDoTime(jogoId, estadioId, timeId) {
    jogoSelecionadoId = jogoId;
    estadioSelecionadoId = estadioId;
    timeSelecionadoId = timeId;
    mostrarSecao('lives');
}
function verStreamersDaLive(jogoId, estadioId, timeId, liveId) {
    jogoSelecionadoId = jogoId;
    estadioSelecionadoId = estadioId;
    timeSelecionadoId = timeId;
    liveSelecionadoId = liveId;
    mostrarSecao('streamers');
}
// Inicializa√ß√£o





////////////
////////////
////////////
////////////jogos
////////////
////////////
////////////



function gerarBotoesEstadio(jogoId, estadioId) {
    const jogo = dados.jogos.find(j => j.id === jogoId);
    const estadio = jogo?.estadios.find(e => e.id === estadioId);
    if (!estadio) return '';

    const isCopiado = estadioCopiado && estadioCopiado.id === estadioId && estadioCopiado.jogoId === jogoId;

    let botoes = `
        <button style="padding:6px 10px; border:none; border-radius:5px; color:white; background:#17a2b8; cursor:pointer; font-size:0.85em;" 
                onclick="verDetalhesEstadio(${jogoId}, ${estadioId})">Ver</button>
        <button style="padding:6px 10px; border:none; border-radius:5px; color:white; background:#ffc107; cursor:pointer; font-size:0.85em;" 
                onclick="editarEstadio(${jogoId}, ${estadioId})">Editar</button>
        <button style="padding:6px 10px; border:none; border-radius:5px; color:white; background:#6c757d; cursor:pointer; font-size:0.85em;" 
                onclick="alterarImagemEstadio(${jogoId}, ${estadioId})">Imagem</button>
        <button style="padding:6px 10px; border:none; border-radius:5px; color:white; background:#dc3545; cursor:pointer; font-size:0.85em;" 
                onclick="excluirEstadio(${jogoId}, ${estadioId})">Excluir</button>
        <button style="padding:6px 10px; border:none; border-radius:5px; color:white; background:#007bff; cursor:pointer; font-size:0.85em;" 
                onclick="compartilharEstadio(${jogoId}, ${estadioId})">Compartilhar</button>
      
      
      
        <button style="padding:6px 10px; border:none; border-radius:5px; color:white; background:#28a745; cursor:pointer; font-size:0.85em;" 
                onclick="compartilharAppSintonizadaEstadio(${estadioId})">
                App+Est√°dio</button>
                <button style="padding:6px 10px; border:none; border-radius:5px; color:white; background:#9c27b0; cursor:pointer; font-size:0.85em;" 
        onclick="abrirChatParaItem('estadio', ${estadio.id}, '${escapeStringForHTML(estadio.nome)}')">

    üí¨ Chat est√°dio
</button>
    `;

    // Bot√£o Copiar
    botoes += `
        <button style="padding:6px 10px; border:none; border-radius:5px; color:white; cursor:pointer; font-size:0.85em; background:${isCopiado ? '#28a745' : '#6f42c1'};"
                onclick="copiarEstadio(${jogoId}, ${estadioId})">
            ${isCopiado ? 'Copiado' : 'Copiar'}
        </button>
    `;
        // Bot√£o Copiar
    botoes += `
    <!--
        <button   onclick="entrarSalaEstadio(${jogoId}, ${estadioId})">
        entrar estadio
        </button>-->
    `;
  
    
    

  

    return botoes;
}
// Fun√ß√µes auxiliares para entrar nas salas de chat
function entrarSalaJogo(jogoId) {
    const jogo = dados.jogos.find(j => j.id === jogoId);
    if (jogo) {
        abrirChatParaItem('jogo', jogo.id, escapeStringForHTML(jogo.nome));
    }
}
function entrarSalaEstadio(jogoId, estadioId) {
    const jogo = dados.jogos.find(j => j.id === jogoId);
    const estadio = jogo?.estadios.find(e => e.id === estadioId);
    if (estadio) {
        abrirChatParaItem('estadio', estadio.id, escapeStringForHTML(estadio.nome));
    }
}
function entrarSalaTime(jogoId, estadioId, timeId) {
    const jogo = dados.jogos.find(j => j.id === jogoId);
    const estadio = jogo?.estadios.find(e => e.id === estadioId);
    const time = estadio?.times.find(t => t.id === timeId);
    if (time) {
        abrirChatParaItem('time', time.id, escapeStringForHTML(time.nome));
    }
}
function entrarSalaLive(jogoId, estadioId, timeId, liveId) {
    const live = encontrarLive(jogoId, estadioId, timeId, liveId);
    if (live) {
        abrirChatParaItem('live', live.id, escapeStringForHTML(live.titulo));
    }
}
function entrarSalaDiv(jogoId, estadioId, timeId, liveId, divId) {
    const div = encontrarDivHorizontal(jogoId, estadioId, timeId, liveId, divId);
    if (div) {
        abrirChatParaItem('div', div.id, escapeStringForHTML(div.titulo));
    }
}
function entrarSalaCard(jogoId, estadioId, timeId, liveId, divId, cardId) {
    const card = encontrarCard(jogoId, estadioId, timeId, liveId, divId, cardId);
    if (card) {
        abrirChatParaItem('card', card.id, escapeStringForHTML(card.titulo));
    }
}
/////
/////
/////
function entrarSalaIframe(jogoId, estadioId, timeId, liveId, divId, cardId) {
    const card = encontrarCard(jogoId, estadioId, timeId, liveId, divId, cardId);
    if (card) {
        abrirChatParaItem('iframe', card.id, escapeStringForHTML(card.titulo));
    }
}







function carregarJogos() {
    const container = document.getElementById('lista-jogos');
    if (!container) return;

    container.innerHTML = '';

    if (dados.jogos.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#666;">Nenhum jogo cadastrado.</p>';
        return;
    }

    // Estado do toggle (opcional: pode ser salvo em localStorage)
    const toggleStates = {};

    dados.jogos.forEach(jogo => {
        const jogoId = jogo.id;
        const isExpanded = toggleStates[jogoId] || false;

        // === CONTAINER PRINCIPAL ===
        const jogoEl = document.createElement('div');
        jogoEl.className = 'jogo-item';
        jogoEl.style = 'border:1px solid #ddd; margin:15px 0; padding:15px; border-radius:8px; background:#fafafa;';

        // === HEADER (IFRAME + T√çTULO + TOGGLE) ===
        const header = document.createElement('div');
        header.style = 'display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;';

        const leftSide = document.createElement('div');
        leftSide.style = 'display:flex; align-items:center; gap:15px;';

        // === CONTAINER DO IFRAME ===
        const iframeContainer = document.createElement('div');
        iframeContainer.style = 'position: relative; width:150%; height:100%; overflow:hidden; border-radius:8px; cursor:pointer;';

        // SEMPRE usar iframe do backend
        if (jogo.iframeUrl) {
            const iframe = document.createElement('iframe');
            iframe.src = jogo.iframeUrl;
            iframe.style = 'width:100%; height:100%; border:none; border-radius:8px;';
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
            iframe.loading = 'lazy';
            iframe.title = jogo.nome;

            // === OVERLAY PARA CAPTURAR CLIQUE ===
            const overlay = document.createElement('div');
            overlay.style = `
                position: absolute; top:0; left:0; width:100%; height:100%; 
                background: transparent; z-index: 1; cursor: pointer;
            `;
            overlay.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                verEstadiosDoJogo(jogo.id);
            };

            iframeContainer.appendChild(iframe);
            iframeContainer.appendChild(overlay);
        } else {
            // Fallback caso n√£o tenha iframeUrl
            const placeholder = document.createElement('div');
            placeholder.style = 'width:100%; height:100%; background:#e0e0e0; display:flex; align-items:center; justify-content:center; border-radius:8px;';
            placeholder.innerHTML = 'üéÆ';
            placeholder.onclick = () => verEstadiosDoJogo(jogo.id);
            iframeContainer.appendChild(placeholder);
        }

        leftSide.appendChild(iframeContainer);

        const textoLado = document.createElement('div');
        const h3 = document.createElement('h3');
        h3.textContent = jogo.nome;
        h3.style = 'margin:0; cursor:pointer; color:#007bff; font-size:1.1em;';
        h3.onclick = () => verEstadiosDoJogo(jogo.id);

        const p = document.createElement('p');
        p.textContent = `ID: ${jogo.id} | Est√°dios: ${jogo.estadios.length}`;
        p.style = 'margin:3px 0; color:#555; font-size:0.9em;';

       // textoLado.appendChild(h3);
     //   textoLado.appendChild(p);
      //  leftSide.appendChild(textoLado);

        // === BOT√ÉO TOGGLE ===
        const toggleBtn = document.createElement('button');
        toggleBtn.innerHTML = isExpanded ? '‚àí' : '+';
        toggleBtn.style = `
            width:36px; height:36px; border:none; border-radius:50%; 
            background:#007bff; color:white; font-weight:bold; font-size:1.2em;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            transition:0.2s;
        `;
        toggleBtn.onmouseover = () => toggleBtn.style.background = '#0056b3';
        toggleBtn.onmouseout = () => toggleBtn.style.background = '#007bff';

        // === CONTAINER DE BOT√ïES (ocult√°vel) ===
        const botoesContainer = document.createElement('div');
        botoesContainer.id = `botoes-${jogoId}`;
        botoesContainer.style = `
            display: ${isExpanded ? 'flex' : 'none'};
            flex-wrap: wrap; gap: 8px; justify-content: center;
            margin-top: 12px; padding: 10px; background: #f8f9fa;
            border-radius: 6px; transition: all 0.3s ease;
        `;

        // === LISTA DE BOT√ïES ===
        const botoes = [
            { text: 'Ver', color: '#17a2b8', click: () => verDetalhesJogo(jogo.id) },
            { text: 'Editar', color: '#ffc107', click: () => editarJogo(jogo.id) },
            { text: 'Excluir', color: '#dc3545', click: () => excluirJogo(jogo.id) },
            { text: 'Compartilhar', color: '#007bff', click: () => compartilharJogo(jogo.id) },
            { text: 'App+Jogo', color: '#28a745', click: () => compartilharAppSintonizadaJogo(jogo.id) },
        ];

        botoes.forEach(btn => {
            const button = document.createElement('button');
            button.textContent = btn.text;
            button.style = `
                padding:6px 10px; border:none; border-radius:5px; 
                color:white; background:${btn.color}; cursor:pointer; 
                font-size:0.85em; min-width:70px; transition:0.2s;
            `;
            button.onclick = btn.click;
            botoesContainer.appendChild(button);
        });

        // === BOT√ÉO COPIAR ===
        const isCopiado = jogoCopiado && jogoCopiado.id === jogo.id;
        const btnCopiar = document.createElement('button');
        btnCopiar.innerHTML = isCopiado ? 'Copiado' : 'Copiar';
        btnCopiar.style = `
            padding:6px 10px; border:none; border-radius:5px; 
            color:white; cursor:pointer; font-size:0.85em;
            background: ${isCopiado ? '#28a745' : '#6f42c1'};
        `;
        
        btnCopiar.onclick = () => {
            jogoCopiado = JSON.parse(JSON.stringify(jogo));
            mostrarNotificacao(`Jogo "${jogo.nome}" copiado!`, 'sucesso');
            carregarJogos();
        };
        botoesContainer.appendChild(btnCopiar);

        // === BOT√ÉO P2P (se houver jogo copiado) ===
        if (jogoCopiado) {
            const btnP2P = document.createElement('button');
            btnP2P.textContent = 'P2P';
            btnP2P.style = 'padding:6px 10px; background:#ff6b35; color:white; border:none; border-radius:5px; font-size:0.85em; cursor:pointer;';
            // btnP2P.onclick = enviarJogoCopiadoViaP2P;
            botoesContainer.appendChild(btnP2P);
        }

        // === BOT√ÉO CHAT DO JOGO ===
        const btnSalaJogo = document.createElement('button');
        btnSalaJogo.innerHTML = 'üí¨ Chat jogo';
        btnSalaJogo.onclick = () => abrirChatParaItem('jogo', jogo.id, escapeStringForHTML(jogo.nome));
        botoesContainer.appendChild(btnSalaJogo);

        // === TOGGLE FUNCIONALIDADE ===
        toggleBtn.onclick = () => {
            const expanded = botoesContainer.style.display === 'flex';
            botoesContainer.style.display = expanded ? 'none' : 'flex';
            toggleBtn.innerHTML = expanded ? '+' : '‚àí';
            toggleStates[jogoId] = !expanded;
        };

        // === MONTAGEM FINAL ===
        header.appendChild(leftSide);
        header.appendChild(toggleBtn);
        jogoEl.appendChild(header);
        jogoEl.appendChild(botoesContainer);
        jogoEl.appendChild(document.createElement('hr'));

        container.appendChild(jogoEl);
    });
}
// No in√≠cio do script, ap√≥s carregar dados
if (dados.jogos && dados.jogos.length > 0) {
    console.log('Sistema carregado com sucesso');
    // For√ßar recarregamento inicial se necess√°rio
    setTimeout(() => {
        carregarJogos();
        if (typeof adicionarBotoesApostasDesafios === 'function') {
            adicionarBotoesApostasDesafios();
        }
    }, 100);
}
function carregarEstadiosDoJogo(jogoId) {
    const container = document.getElementById('lista-estadios');
    container.innerHTML = '';

    const jogo = dados.jogos.find(j => j.id === jogoId);
    if (!jogo) return alert("Jogo n√£o encontrado!");

    document.querySelector('#secao-estadios h2').textContent = `Est√°dios - ${jogo.nome}`;

    // === BOT√ÉO ADICIONAR + COMPARTILHAR ===
    const topo = document.createElement('div');
    topo.innerHTML = `
        <div style="text-align: center; margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">

            <button onclick="adicionarEstadio()" style="background:#28a745; color:white; padding:8px 12px; border:none; border-radius:5px; font-size:0.9em;">
                + Criar novo estadio
            </button>
            <button onclick="colarEstadioCopiado()" style="background:#6f42c1; color:white; padding:8px 12px; border:none; border-radius:5px; font-size:0.9em;">
                Colar estadio
            </button>

        </div>
    `;
  //  container.appendChild(topo);

    // === LISTAR EST√ÅDIOS ===
    jogo.estadios.forEach(estadio => {
        const el = document.createElement('div');
        el.innerHTML = gerarHTMLCardEstadio(jogo, estadio);
        container.appendChild(el);
    });
}
// === 2. LISTAR TODOS OS EST√ÅDIOS (VIS√ÉO GERAL) ===
function carregarEstadios() {
    const container = document.getElementById('lista-estadios');
    container.innerHTML = '';

    document.querySelector('#secao-estadios h2').textContent = 'Todos os Est√°dios';

    let totalEstadios = 0;
    dados.jogos.forEach(j => totalEstadios += j.estadios.length);

    if (totalEstadios === 0) {
        container.innerHTML = '<p style="text-align:center; color:#666;">Nenhum est√°dio cadastrado.</p>';
        return;
    }

    dados.jogos.forEach(jogo => {
        if (jogo.estadios.length === 0) return;

        const titulo = document.createElement('h3');
        titulo.textContent = `Jogo: ${jogo.nome}`;
        titulo.style = 'margin:20px 0 10px; padding-bottom:5px; border-bottom:1px solid #ddd;';
      //  container.appendChild(titulo);

        jogo.estadios.forEach(estadio => {
            const el = document.createElement('div');
            el.innerHTML = gerarHTMLCardEstadio(jogo, estadio, true);
            container.appendChild(el);
        });
    });
}
// === VARI√ÅVEIS GLOBAIS ===
// === 1. LISTAR TIMES DE UM EST√ÅDIO ===
function carregarTimesDoEstadio(jogoId, estadioId) {
    const container = document.getElementById('lista-times');
    container.innerHTML = '';

    const jogo = dados.jogos.find(j => j.id === jogoId);
    if (!jogo) return alert("Jogo n√£o encontrado!");

    const estadio = jogo.estadios.find(e => e.id === estadioId);
    if (!estadio) return alert("Est√°dio n√£o encontrado!");

    document.querySelector('#secao-times h2').textContent = `Times - ${estadio.nome} (${jogo.nome})`;

    // === TOPO: ADICIONAR + COMPARTILHAR ===
    const topo = document.createElement('div');
    topo.innerHTML = `
        <div style="text-align: center; margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
            <button onclick="adicionarTime(${jogoId}, ${estadioId})" style="background:#28a745; color:white; padding:8px 12px; border:none; border-radius:5px; font-size:0.9em;">
                + Criar novo Time
            </button>
            <button onclick="colarTimeCopiado(${jogoId}, ${estadioId})" style="background:#6f42c1; color:white; padding:8px 12px; border:none; border-radius:5px; font-size:0.9em;">
                Colar Time
            </button>
        </div>
    `;
    container.appendChild(topo);

    // === LISTAR TIMES ===
    estadio.times.forEach(time => {
        const el = document.createElement('div');
        el.innerHTML = gerarHTMLCardTime(jogo, estadio, time);
        container.appendChild(el);
    });
}
// === 2. LISTAR TODOS OS TIMES (VIS√ÉO GERAL) ===
function carregarTimes() {
    const container = document.getElementById('lista-times');
    container.innerHTML = '';

    document.querySelector('#secao-times h2').textContent = 'Todos os Times';

    let totalTimes = 0;
    dados.jogos.forEach(j => j.estadios.forEach(e => totalTimes += e.times.length));

    if (totalTimes === 0) {
        container.innerHTML = '<p style="text-align:center; color:#666;">Nenhum time cadastrado.</p>';
        return;
    }

    dados.jogos.forEach(jogo => {
        jogo.estadios.forEach(estadio => {
            if (estadio.times.length === 0) return;

            const titulo = document.createElement('h3');
            titulo.textContent = `Est√°dio: ${estadio.nome} | Jogo: ${jogo.nome}`;
            titulo.style = 'margin:20px 0 10px; padding-bottom:5px; border-bottom:1px solid #ddd;';
            container.appendChild(titulo);

            estadio.times.forEach(time => {
                const el = document.createElement('div');
                el.innerHTML = gerarHTMLCardTime(jogo, estadio, time, true);
                container.appendChild(el);
            });
        });
    });
}
// === 1. LISTAR EST√ÅDIOS DE UM JOGO ESPEC√çFICO ===
function gerarHTMLCardEstadio(jogo, estadio, modoGeral = false) {
    const jogoId = jogo.id;
    const estadioId = estadio.id;

    // Estado do toggle
    const toggleStates = {};
    const isExpanded = toggleStates[estadioId] || false;

    // === CONTAINER PRINCIPAL ===
    const cardHTML = `
        <div class="estadio-item" style="border:1px solid #ddd; margin:15px 0; padding:15px; border-radius:8px; background:#fafafa;">
            <!-- HEADER -->
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                <div style="display:flex; align-items:center; gap:15px;">
                    ${estadio.iframeUrl ? `
                        <div style="position: relative; width:90%; height:90%; overflow:hidden; border-radius:8px; cursor:pointer;">
                            <iframe src="${estadio.iframeUrl}" 
                                    style="width:100%; height:100%; border:none; border-radius:8px;"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                    loading="lazy"
                                    title="${estadio.nome}">
                            </iframe>
                            <div style="position: absolute; top:0; left:0; width:100%; height:100%; 
                                        background: transparent; z-index: 1; cursor: pointer;"
                                 onclick="verTimesDoEstadio(${jogoId}, ${estadioId})"></div>
                        </div>
                    ` : `
                        <div style="width:120px; height:80px; background:#e0e0e0; display:flex; align-items:center; justify-content:center; border-radius:8px; cursor:pointer;"
                             onclick="verTimesDoEstadio(${jogoId}, ${estadioId})">
                            üèüÔ∏è
                        </div>
                    `}
                    <div>
                        <h3 style="margin:0; cursor:pointer; color:#007bff; font-size:1.1em;" 
                            onclick="verTimesDoEstadio(${jogoId}, ${estadioId})">
                            ${estadio.nome}
                        </h3>
                        <p style="margin:3px 0; color:#555; font-size:0.9em;">
                            ID: ${estadioId}${modoGeral ? ` | Jogo: ${jogo.nome}` : ''}
                            | Times: ${estadio.times.length}
                        </p>
                    </div>
                </div>
                <button id="toggle-${estadioId}" 
                        style="width:36px; height:36px; border:none; border-radius:50%; background:#007bff; color:white; font-weight:bold; font-size:1.2em; cursor:pointer; display:flex; align-items:center; justify-content:center;"
                        onclick="toggleEstadioBotoes(${estadioId})">
                    ${isExpanded ? '‚àí' : '+'}
                </button>
            </div>

            <!-- BOT√ïES (ocult√°veis) -->
            <div id="botoes-estadio-${estadioId}" 
                 style="display:${isExpanded ? 'flex' : 'none'}; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:12px; padding:10px; background:#f8f9fa; border-radius:6px;">
                ${gerarBotoesEstadio(jogoId, estadioId)}
            </div>
            <hr>
        </div>
    `;

    return cardHTML;
}
// === FUN√á√ÉO PARA GERAR CARD DO TIME COM BOT√ÉO PARA IFRAMES ===
function gerarHTMLCardTime(jogo, estadio, time, mostrarLocal = false) {
    const localInfo = mostrarLocal ? 
        `<div style="font-size: 0.8em; color: #666; margin-bottom: 8px;">
            Jogo: ${jogo.nome} | Est√°dio: ${estadio.nome}
        </div>` : '';

    return `
        <div class="card-time" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            ${localInfo}
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h4 style="margin: 0 0 5px 0; color: #333;">${time.nome}</h4>
                    <p style="margin: 0; color: #666; font-size: 0.9em;">${time.descricao || 'Sem descri√ß√£o'}</p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="abrirIframesTime(${jogo.id}, ${estadio.id}, ${time.id})" 
                            style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                        üñºÔ∏è Abrir Iframes
                    </button>
                    <button onclick="editarTime(${jogo.id}, ${estadio.id}, ${time.id})" 
                            style="background: #ffc107; color: black; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                        ‚úèÔ∏è Editar
                    </button>
                    <button onclick="excluirTime(${jogo.id}, ${estadio.id}, ${time.id})" 
                            style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                        üóëÔ∏è Excluir
                    </button>
                </div>
            </div>
        </div>
    `;
}


////////////
////////////
////////////estadio
////////////
////////////
////////////




////////////
////////////
////////////  times
////////////
////////////
////////////
// Fun√ß√£o para ver detalhes do time
function verDetalhesTime(jogoId, estadioId, timeId) {
    const jogo = dados.jogos.find(j => j.id === jogoId);
    if (jogo) {
        const estadio = jogo.estadios.find(e => e.id === estadioId);
        if (estadio) {
            const time = estadio.times.find(t => t.id === timeId);
            if (time) {
                alert(`Detalhes do Time:\nNome: ${time.nome}\nID: ${time.id}\nLives: ${time.lives ? time.lives.length : 0}`);
            }
        }
    }
}
function verLivesDoTime(jogoId, estadioId, timeId) {
    jogoSelecionadoId = jogoId;
    estadioSelecionadoId = estadioId;
    mostrarSecao('lives');
    carregarLivesDoTime(jogoId, estadioId, timeId);
}









function adicionarEstadio() {
    if (!jogoSelecionadoId) return alert("Selecione um jogo primeiro!");

    const jogo = dados.jogos.find(j => j.id === jogoSelecionadoId);
    const novoId = jogo.estadios.length ? Math.max(...jogo.estadios.map(e => e.id)) + 1 : 1;
    const nome = prompt("Nome do est√°dio:");
    if (!nome?.trim()) return;

    jogo.estadios.push({ id: novoId, nome: nome.trim(), imagem: "estadio.jpg", times: [] });
    carregarEstadiosDoJogo(jogoSelecionadoId);
    alert("Est√°dio adicionado!");
}
function alterarImagemEstadio(jogoId, estadioId) {
    const jogo = dados.jogos.find(j => j.id === jogoId);
    if (!jogo) return;
    
    const estadio = jogo.estadios.find(e => e.id === estadioId);
    if (!estadio) return;
    
    const novaImagem = prompt("URL da nova imagem (deixe em branco para padr√£o):", estadio.imagem);
    if (novaImagem !== null) {
        estadio.imagem = novaImagem;
        carregarEstadiosDoJogo(jogoId);
        alert("Imagem atualizada!");
    }
}
// Fun√ß√£o para navegar para os times de um est√°dio espec√≠fico
function verTimesDoEstadio(jogoId, estadioId) {
    jogoSelecionadoId = jogoId;
    estadioSelecionadoId = estadioId;
    mostrarSecao('times');
    carregarTimesDoEstadio(jogoId, estadioId);
}
// Fun√ß√£o para ver detalhes do est√°dio
function verDetalhesEstadio(jogoId, estadioId) {
    const jogo = dados.jogos.find(j => j.id === jogoId);
    if (jogo) {
        const estadio = jogo.estadios.find(e => e.id === estadioId);
        if (estadio) {
            alert(`Detalhes do Est√°dio:\nNome: ${estadio.nome}\nID: ${estadio.id}\nTimes: ${estadio.times.length}`);
        }
    }
}
// === FUN√á√ÉO PARA ABRIR IFRAMES DO TIME ===
function abrirIframesTime(jogoId, estadioId, timeId) {
    // Encontrar os dados do time
    const jogo = dados.jogos.find(j => j.id === jogoId);
    const estadio = jogo.estadios.find(e => e.id === estadioId);
    const time = estadio.times.find(t => t.id === timeId);

    if (!time) {
        alert('Time n√£o encontrado!');
        return;
    }

    // Salvar dados do time no localStorage para usar na p√°gina de iframes
    const timeData = {
        jogoId: jogoId,
        estadioId: estadioId,
        timeId: timeId,
        jogo: jogo.nome,
        estadio: estadio.nome,
        time: time.nome,
        iframes: time.iframes || [] // Assumindo que o time tem propriedade iframes
    };

    localStorage.setItem('timeSelecionado', JSON.stringify(timeData));
    
    // Redirecionar para a p√°gina de iframes
    window.location.href = 'iframes.html';
}
function adicionarChatTime(time) {
    const btnChatTime = document.createElement('button');
    btnChatTime.innerHTML = 'üí¨ Chat time';
    btnChatTime.onclick = () => abrirChatParaItem('time', time.id, time.nome);
    return btnChatTime;
}
// Fun√ß√£o para adicionar jogo (COM LOG)
function adicionarJogo() {
    const novoId = dados.jogos.length > 0 ? Math.max(...dados.jogos.map(j => j.id)) + 1 : 1;
    
    const nome = prompt("Nome do Jogo:");
    if (!nome) return;
    
    const novoJogo = {
        id: novoId,
        nome: nome,
        imagem: "jogo.jpg",
        estadios: []
    };
    
    dados.jogos.push(novoJogo);
    
    // === LOG ADICIONADO ===
    console.group(`JOGO ADICIONADO: "${nome}" (ID: ${novoId})`);
    //console.log("Jogo adicionado:", novoJogo);
    //console.log("Objeto completo 'dados.jogos':", dados.jogos);
    //console.log("Estrutura completa 'dados':", JSON.parse(JSON.stringify(dados))); // deep clone para log
    console.groupEnd();
    // =======================

    carregarJogos();
    alert(`Jogo "${nome}" adicionado com ID: ${novoId}`);
}
function verEstadiosDoJogo(jogoId) {
    jogoSelecionadoId = jogoId;
    mostrarSecao('estadios');
    carregarEstadiosDoJogo(jogoId);
}
// Fun√ß√£o para ver detalhes do jogo
function verDetalhesJogo(jogoId) {
    const jogo = dados.jogos.find(j => j.id === jogoId);
    if (jogo) {
        alert(`Detalhes do Jogo:\nNome: ${jogo.nome}\nID: ${jogo.id}\nEst√°dios: ${jogo.estadios.length}`);
    }
}
// Fun√ß√£o para editar jogo
function editarJogo(id) {
    const jogo = dados.jogos.find(j => j.id === id);
    if (jogo) {
        const novoNome = prompt("Novo nome do Jogo:", jogo.nome);
        if (novoNome) {
            jogo.nome = novoNome;
            carregarJogos();
        }
    }
}
// Fun√ß√£o para excluir jogo
function excluirJogo(id) {
    if (confirm("Tem certeza que deseja excluir este jogo e todos os seus est√°dios, times e streamers?")) {
        dados.jogos = dados.jogos.filter(j => j.id !== id);
        carregarJogos();
    }
}
// Fun√ß√£o para editar est√°dio
function editarEstadio(jogoId, estadioId) {
    const jogo = dados.jogos.find(j => j.id === jogoId);
    if (jogo) {
        const estadio = jogo.estadios.find(e => e.id === estadioId);
        if (estadio) {
            const novoNome = prompt("Novo nome do Est√°dio:", estadio.nome);
            if (novoNome) {
                estadio.nome = novoNome;
                carregarEstadiosDoJogo(jogoId);
            }
        }
    }
}
// Fun√ß√£o para excluir est√°dio
function excluirEstadio(jogoId, estadioId) {
    if (confirm("Tem certeza que deseja excluir este est√°dio e todos os seus times e streamers?")) {
        const jogo = dados.jogos.find(j => j.id === jogoId);
        if (jogo) {
            jogo.estadios = jogo.estadios.filter(e => e.id !== estadioId);
            carregarEstadiosDoJogo(jogoId);
        }
    }
}
function editarTime(jogoId, estadioId, timeId) {
    const jogo = dados.jogos.find(j => j.id === jogoId);
    if (jogo) {
        const estadio = jogo.estadios.find(e => e.id === estadioId);
        if (estadio) {
            const time = estadio.times.find(t => t.id === timeId);
            if (time) {
                const novoNome = prompt("Novo nome do Time:", time.nome);
                if (novoNome) {
                    time.nome = novoNome;
                    carregarTimesDoEstadio(jogoId, estadioId);
                }
            }
        }
    }
}
// Fun√ß√£o para excluir time
function excluirTime(jogoId, estadioId, timeId) {
    if (confirm("Tem certeza que deseja excluir este time e todas as suas lives?")) {
        const jogo = dados.jogos.find(j => j.id === jogoId);
        if (jogo) {
            const estadio = jogo.estadios.find(e => e.id === estadioId);
            if (estadio) {
                estadio.times = estadio.times.filter(t => t.id !== timeId);
                carregarTimesDoEstadio(jogoId, estadioId);
            }
        }
    }
}

////////////
////////////
////////////  live.js
////////////
////////////



////////////
////////////
////////////
////////////
////////////
////////////
function painelAdmin() {
    const senha = prompt("Senha de administrador:");
    if (senha !== "admin123") {
        alert("Senha incorreta!");
        return;
    }
    
    let painel = "=== PAINEL ADMIN ===\n\n";
    painel += "1. Estat√≠sticas Gerais\n";
    painel += "2. Gerenciar Usu√°rios\n";
    painel += "3. Gerenciar Streamers\n";
    painel += "4. Limpar Dados\n";
    painel += "5. Backup/Restore\n";
    
    const opcao = prompt(painel);
    
    switch(opcao) {
        case '1':
            verEstatisticas();
            break;
        case '2':
            gerenciarUsuarios();
            break;
        case '4':
            limparDados();
            break;
    }
}
function verEstatisticas() {
    let stats = "=== ESTAT√çSTICAS ===\n\n";
    stats += `Total de Usu√°rios: ${dados.usuarios.length}\n`;
    stats += `Total de Streamers: ${contarStreamers()}\n`;
    stats += `Total de Desafios: ${contarDesafios()}\n`;
    stats += `Total de Transa√ß√µes: ${dados.transacoes.length}\n`;
    stats += `Total em M√©rito Circulante: ${calcularMeritoTotal()}\n`;
    alert(stats);
}
function contarStreamers() {
    let count = 0;
    dados.jogos.forEach(jogo => {
        jogo.estadios.forEach(estadio => {
            estadio.times.forEach(time => {
                if (time.lives) {
                    time.lives.forEach(live => {
                        count += live.streamers ? live.streamers.length : 0;
                    });
                }
            });
        });
    });
    return count;
}
function criarEvento() {
    if (!streamerLogado) {
        alert("Apenas streamers podem criar eventos");
        return;
    }
    
    const nome = prompt("Nome do evento:");
    if (!nome) return;
    
    const descricao = prompt("Descri√ß√£o do evento:");
    const data = prompt("Data do evento (ex: 25/12/2023 20:00):");
    const premio = prompt("Pr√™mio do evento:");
    
    const novoEvento = {
        id: Date.now(),
        nome: nome,
        descricao: descricao,
        data: data,
        premio: premio,
        criador: streamerLogado.nome,
        participantes: [],
        status: "inscricoes_abertas"
    };
    
    eventos.push(novoEvento);
    adicionarNotificacao("Novo Evento!", `${streamerLogado.nome} criou o evento: ${nome}`, 'info');
    alert("Evento criado com sucesso!");
}
function verEventos() {
    if (eventos.length === 0) {
        alert("Nenhum evento agendado");
        return;
    }
    
    let lista = "=== EVENTOS ===\n\n";
    eventos.forEach((evento, index) => {
        lista += `üéØ ${evento.nome}\n`;
        lista += `Descri√ß√£o: ${evento.descricao}\n`;
        lista += `Data: ${evento.data}\n`;
        lista += `Pr√™mio: ${evento.premio}\n`;
        lista += `Criador: ${evento.criador}\n`;
        lista += `Participantes: ${evento.participantes.length}\n`;
        lista += `Status: ${evento.status}\n`;
        
        if (usuarioLogado && evento.status === "inscricoes_abertas") {
            lista += `[Participar - digite 'p ${index}']\n`;
        }
        lista += "------------------------\n";
    });
    
    if (usuarioLogado) {
        lista += "\nComandos: 'p [n√∫mero]' - participar do evento";
    }
    
    const comando = prompt(lista);
    
    if (comando && comando.startsWith('p ')) {
        const index = parseInt(comando.split(' ')[1]);
        if (!isNaN(index) && index >= 0 && index < eventos.length) {
            participarEvento(eventos[index].id);
        }
    }
}
function participarEvento(eventoId) {
    if (!usuarioLogado) {
        alert("Fa√ßa login como usu√°rio para participar!");
        return;
    }
    
    const evento = eventos.find(e => e.id === eventoId);
    if (!evento) {
        alert("Evento n√£o encontrado!");
        return;
    }
    
    if (evento.status !== "inscricoes_abertas") {
        alert("Inscri√ß√µes encerradas para este evento!");
        return;
    }
    
    if (evento.participantes.includes(usuarioLogado.nome)) {
        alert("Voc√™ j√° est√° participando deste evento!");
        return;
    }
    
    evento.participantes.push(usuarioLogado.nome);
    adicionarNotificacao("Inscri√ß√£o Confirmada!", `Voc√™ se inscreveu no evento: ${evento.nome}`, 'sucesso');
    alert(`Inscri√ß√£o confirmada no evento: ${evento.nome}`);
}
function finalizarEvento(eventoId, vencedor) {
    const evento = eventos.find(e => e.id === eventoId);
    if (!evento) return;
    
    evento.status = "finalizado";
    evento.vencedor = vencedor;
    evento.dataFinalizacao = new Date().toLocaleString();
    
    adicionarNotificacao("Evento Finalizado!", `O evento ${evento.nome} foi finalizado. Vencedor: ${vencedor}`, 'info');
    alert(`Evento finalizado! Vencedor: ${vencedor}`);
}
// Sistema de c√°lculo de m√©rito
function calcularMeritoMaximoAposta(usuario) {
    // M√©rito m√°ximo = m√©rito atual * 2 (pode apostar at√© o dobro do seu m√©rito)
    return usuario.merito * 2;
}
// No merito.js, substituir a fun√ß√£o verPerfil por:
function verPerfil() {
    verPerfilCompleto(); // Usar a nova fun√ß√£o completa
}
function verRankingUsuarios() {
    const usuariosOrdenados = [...dados.usuarios].sort((a, b) => b.merito - a.merito);
    
    let ranking = "=== RANKING DE USU√ÅRIOS ===\n\n";
    usuariosOrdenados.forEach((usuario, index) => {
        ranking += `${index + 1}¬∫ - ${usuario.nome}\n`;
        ranking += `M√©rito: ${usuario.merito} pontos\n`;
        ranking += `Desafios: ${usuario.desafiosCumpridos}/${usuario.desafiosCumpridos + usuario.desafiosFalhados} cumpridos\n`;
        ranking += "------------------------\n";
    });
    alert(ranking);
}
function verRankingStreamers() {
    let todosStreamers = [];
    dados.jogos.forEach(jogo => {
        jogo.estadios.forEach(estadio => {
            estadio.times.forEach(time => {
                if (time.lives) {
                    time.lives.forEach(live => {
                        if (live.streamers) {
                            todosStreamers = todosStreamers.concat(live.streamers);
                        }
                    });
                }
            });
        });
    });
    
    const streamersOrdenados = todosStreamers.sort((a, b) => b.merito - a.merito);
    
    let ranking = "=== RANKING DE STREAMERS ===\n\n";
    streamersOrdenados.forEach((streamer, index) => {
        ranking += `${index + 1}¬∫ - ${streamer.nome}\n`;
        ranking += `M√©rito: ${streamer.merito} pontos\n`;
        ranking += `Online: ${streamer.online ? 'üü¢' : 'üî¥'}\n`;
        ranking += "------------------------\n";
    });
    alert(ranking);
}

 
  
////////////
////////////
////////////apostas
////////////
////////////
////////////
function salvarEAtualizar(jogoId, estadioId, timeId) {
    salvarDados();
    carregarLivesDoTime(jogoId, estadioId, timeId);
}

function gerarCardId(videoInfo) {
    const card = videoInfo.closest('.card');
    if (card && card.id) return card.id;

    let titulo = videoInfo.querySelector('h3, h4, .title, .card-title, .video-title, [data-titulo]')?.textContent?.trim();
    if (!titulo) {
        const cardTitle = card?.querySelector('h3, h4, .title, .card-title, .video-title, [data-titulo]')?.textContent?.trim();
        titulo = card?.dataset?.titulo || cardTitle || 'card';
    }

    const container = videoInfo.closest('.div-horizontal, .live-container, .video-container, .live-grid') || document.body;
    const cards = container.querySelectorAll('.card');
    const index = Array.from(cards).indexOf(card) + 1 || 1;
    const id = `card-${btoa(encodeURIComponent(titulo)).substring(0, 8)}-${index}`;
    
    if (card) card.id = id;
    console.log(`gerarCardId: title=${titulo}, index=${index}, id=${id}, container=${container.className}`);
  //  console.log(`videoInfo HTML: ${videoInfo.outerHTML}`);
    return id;
}

function atualizarInterfaceLogin() {
    atualizarMenuPerfil();
    
    const floatingMenu = document.getElementById('loginFloating');
    const overlay = document.getElementById('overlay');
    if (floatingMenu) floatingMenu.classList.remove('show');
    if (overlay) overlay.classList.remove('show');
}
function atualizarMenuPerfil() {
    const floatingMenu = document.getElementById('loginFloating');
    const profileIcon = document.getElementById('profileIcon');
    
    if (!floatingMenu || !profileIcon) return;
    
    if (usuarioLogado || streamerLogado) {
        const usuario = usuarioLogado || streamerLogado;
        const tipo = usuarioLogado ? 'üë§ Usu√°rio' : 'üé• Streamer';
        
        profileIcon.textContent = usuarioLogado ? 'üë§' : 'üé•';
        profileIcon.classList.add('logged-in');
        
        floatingMenu.innerHTML = `
            <div class="user-info">
                <p class="user-name">${usuario.nome}</p>
                <p class="user-merito">${tipo} | M√©rito: ${usuario.merito}</p>
            </div>
            <div class="user-actions">
                <button class="btn-profile" onclick="verPerfilCompleto(); toggleProfileMenu()">Ver Perfil</button>
                <button class="btn-pix" onclick="configurarChavePix(); toggleProfileMenu()">Configurar PIX</button>
                <button class="btn-logout" onclick="logout(); toggleProfileMenu()">Sair</button>
            </div>
        `;
    } else {
        profileIcon.textContent = 'üë§';
        profileIcon.classList.remove('logged-in');
        
        floatingMenu.innerHTML = `
            <div class="user-actions">
                <button class="btn-login" onclick="fazerLogin(); toggleProfileMenu()">Fazer Login</button>
            </div>
        `;
    }
}
function buscarUsuarios() {
    const termo = prompt("Digite o nome do usu√°rio:");
    if (!termo) return;
    
    const usuariosEncontrados = dados.usuarios.filter(u => 
        u.nome.toLowerCase().includes(termo.toLowerCase())
    );
    
    if (usuariosEncontrados.length === 0) {
        alert("Nenhum usu√°rio encontrado!");
        return;
    }
    
    let lista = "=== USU√ÅRIOS ENCONTRADOS ===\n\n";
    usuariosEncontrados.forEach((usuario, index) => {
        lista += `üë§ ${usuario.nome}\n`;
        lista += `M√©rito: ${usuario.merito}\n`;
        
        if (usuarioLogado && usuario.nome !== usuarioLogado.nome) {
            const jaEhAmigo = usuarioLogado.amigos && usuarioLogado.amigos.includes(usuario.nome);
            if (!jaEhAmigo) {
                lista += `[Adicionar amigo - digite 'a ${index}']\n`;
            } else {
                lista += `‚úÖ J√° √© seu amigo\n`;
            }
        }
        lista += "------------------------\n";
    });
    
    if (usuarioLogado) {
        lista += "\nComandos: 'a [n√∫mero]' - adicionar como amigo";
    }
    
    const comando = prompt(lista);
    
    if (comando && comando.startsWith('a ')) {
        const index = parseInt(comando.split(' ')[1]);
        if (!isNaN(index) && index >= 0 && index < usuariosEncontrados.length) {
            adicionarAmigo(usuariosEncontrados[index].nome);
        }
    }
}
function verNotificacoes() {
    if (notificacoes.length === 0) {
        alert("Nenhuma notifica√ß√£o");
        return;
    }
    
    let lista = "=== NOTIFICA√á√ïES ===\n\n";
    notificacoes.forEach((not, index) => {
        lista += `${not.lida ? 'üì≠' : 'üì´'} ${not.titulo}\n`;
        lista += `Mensagem: ${not.mensagem}\n`;
        lista += `Data: ${not.data}\n`;
        lista += `Tipo: ${not.tipo}\n`;
        
        if (!not.lida) {
            lista += `[Marcar como lida - digite 'l ${index}']\n`;
        }
        lista += "------------------------\n";
    });
    
    lista += "\nComandos: 'l [n√∫mero]' - marcar como lida";
    const comando = prompt(lista);
    
    if (comando && comando.startsWith('l ')) {
        const index = parseInt(comando.split(' ')[1]);
        if (!isNaN(index) && index >= 0 && index < notificacoes.length) {
            notificacoes[index].lida = true;
            alert("Notifica√ß√£o marcada como lida!");
        }
    }
}
function limparNotificacoes() {
    if (confirm("Limpar todas as notifica√ß√µes?")) {
        notificacoes = [];
        alert("Notifica√ß√µes limpas!");
    }
}
function getNotificacoesNaoLidas() {
    return notificacoes.filter(not => !not.lida).length;
}
function carregarVideosStreamer(streamer) {
    if (!streamer.videos || streamer.videos.length === 0) {
        return '<p>Nenhum v√≠deo compartilhado</p>';
    }
    
    let html = '<h4>V√≠deos Compartilhados:</h4>';
    streamer.videos.forEach(video => {
        html += `<p><strong>${video.titulo}</strong> - ${video.data}<br>`;
        html += `<a href="${video.url}" target="_blank">Assistir</a></p>`;
    });
    return html;
}
function verTransacoes() {
    alert("Funcionalidade de transa√ß√µes em desenvolvimento...");
}
function enviarComprovantePix(jogoId, estadioId, timeId, liveId, streamerId, desafioId) {
    const streamer = encontrarStreamer(jogoId, estadioId, timeId, liveId, streamerId);
    if (!streamer) return;
    
    let desafio;
    if (streamer.desafiosEnviados) {
        desafio = streamer.desafiosEnviados.find(d => d.id === desafioId);
    }
    
    if (!desafio) {
        alert("Desafio n√£o encontrado!");
        return;
    }
    
    const comprovante = prompt("URL ou descri√ß√£o do comprovante PIX:");
    if (comprovante) {
        desafio.comprovantePix = comprovante;
        carregarStreamersDaLive(jogoId, estadioId, timeId, liveId);
        alert("Comprovante enviado!");
    }
}
// ===== ADICIONAR BOT√ïES DE APOSTAS E DESAFIOS =====
function adicionarBotoesApostasDesafios() {
    const videoInfos = document.querySelectorAll('.video-info');
    videoInfos.forEach(videoInfo => {
        const container = videoInfo.querySelector('.apostas-desafios-container') || document.createElement('div');
        container.className = 'apostas-desafios-container';
        
        const cardId = gerarCardId(videoInfo);
        const salaApostas = dados.apostasUsuarios.find(s => s.cardId === cardId);
        const salaDesafios = dados.desafiosUsuarios.find(s => s.cardId === cardId);

        // Bot√£o de Apostas
        if (!videoInfo.querySelector('.botao-apostas-custom')) {
            const botaoApostas = document.createElement('button');
            botaoApostas.className = 'botao-apostas-custom';
            botaoApostas.setAttribute('aria-label', 'Abrir sala de apostas');
            botaoApostas.innerHTML = 'üí∞ Apostas';
            if (salaApostas && salaApostas.apostas.length > 0) {
                botaoApostas.classList.add('with-red-dot');
            }
            botaoApostas.addEventListener('click', () => abrirModalApostas(videoInfo));
            container.appendChild(botaoApostas);
        }


        if (!videoInfo.contains(container)) {
            videoInfo.appendChild(container);
        }
    });
}
// ===== OBSERVADOR DE DOM PARA BOT√ïES =====
function observarDOMParaBotoes() {
    adicionarBotoesApostasDesafios();
    const observer = new MutationObserver(adicionarBotoesApostasDesafios);
    observer.observe(document.body, { childList: true, subtree: true });
}
// ===== CONFIRMA√á√ÉO DE PARTICIPA√á√ÉO =====
function confirmarParticipacaoAposta(cardId, apostaId) {
    const apostaSala = dados.apostasUsuarios.find(s => s.cardId === cardId);
    if (!apostaSala) {
        alert('Sala de apostas n√£o encontrada!');
        return;
    }

    const aposta = apostaSala.apostas.find(a => a.id == apostaId);
    if (!aposta) {
        alert('Aposta n√£o encontrada!');
        return;
    }

    const usuario = usuarioLogado;
    if (!usuario) {
        alert('Voc√™ precisa estar logado para participar!');
        return;
    }

    // Verifica se j√° participou
    if (aposta.participantes?.some(p => p.usuario === usuario.usuario)) {
        alert('Voc√™ j√° est√° participando desta aposta!');
        return;
    }

    // Verifica m√©rito suficiente
    const meritoMaximo = calcularMeritoMaximoAposta(usuario);
    if (aposta.valor > meritoMaximo) {
        alert(`M√©rito insuficiente! Voc√™ tem ${usuario.merito} e pode apostar at√© ${meritoMaximo}`);
        return;
    }

    // Interface para escolher op√ß√£o
    const opcaoEscolhida = mostrarSelecaoOpcoesAposta(aposta);
    if (!opcaoEscolhida) return;

    // Registra participa√ß√£o
    const participacao = {
        usuario: usuario.usuario,
        opcao: opcaoEscolhida,
        data: new Date().toISOString(),
        valor: aposta.valor,
        _id: `part_${Date.now()}`
    };

    if (!aposta.participantes) aposta.participantes = [];
    aposta.participantes.push(participacao);

    // Atualiza m√©rito do usu√°rio
    usuario.merito -= aposta.valor;

    // Sincroniza com outros usu√°rios
    syncDataToPeers();
    salvarDados();

    adicionarNotificacao(
        'üéâ Aposta Realizada!',
        `Voc√™ apostou ${aposta.valor} m√©ritos em "${opcaoEscolhida}" na aposta "${aposta.titulo}"`,
        'sucesso'
    );

    // Atualiza indicadores
    atualizarIndicadoresApostas();
    
    alert('‚úÖ Aposta realizada com sucesso!');
}
function mostrarSelecaoOpcoesAposta(aposta) {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; justify-content: center;
            align-items: center; z-index: 15000;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
            background: white; border-radius: 15px; padding: 25px;
            width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        `;
        
        let opcoesHTML = '';
        aposta.opcoes.forEach((opcao, index) => {
            // Calcula quantas pessoas j√° escolheram esta op√ß√£o
            const participantesOpcao = aposta.participantes?.filter(p => p.opcao === opcao).length || 0;
            
            opcoesHTML += `
                <button onclick="selecionarOpcaoAposta('${opcao}')" 
                        style="display: block; width: 100%; margin: 10px 0; padding: 12px; 
                               background: #4CAF50; color: white; border: none; 
                               border-radius: 8px; cursor: pointer; font-size: 16px;
                               position: relative;">
                    ${opcao}
                    <span style="font-size: 12px; opacity: 0.8; display: block;">
                        ${participantesOpcao} pessoa(s)
                    </span>
                </button>
            `;
        });
        
        content.innerHTML = `
            <h3>${aposta.titulo}</h3>
            <p><strong>Valor da Aposta:</strong> ${aposta.valor} m√©ritos</p>
            <p><strong>Seu m√©rito atual:</strong> ${usuarioLogado?.merito || 0}</p>
            <p>Escolha sua op√ß√£o:</p>
            ${opcoesHTML}
            <button onclick="fecharModalSelecaoAposta()" 
                    style="margin-top: 15px; padding: 8px 15px; 
                           background: #f44336; color: white; border: none; 
                           border-radius: 5px; cursor: pointer;">
                Cancelar
            </button>
        `;
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        window.selecionarOpcaoAposta = function(opcao) {
            modal.remove();
            resolve(opcao);
        };
        
        window.fecharModalSelecaoAposta = function() {
            modal.remove();
            resolve(null);
        };
        
        // Fecha modal ao clicar fora
        modal.onclick = function(e) {
            if (e.target === modal) {
                window.fecharModalSelecaoAposta();
            }
        };
    });
}
// ===== FORMUL√ÅRIO DE CRIA√á√ÉO DE APOSTA =====
function abrirFormularioCriarAposta(cardId) {
    const usuario = usuarioLogado;
    if (!usuario) {
        alert('Voc√™ precisa estar logado para criar apostas!');
        return;
    }

    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: flex; justify-content: center;
        align-items: center; z-index: 15000;
    `;

    const content = document.createElement('div');
    content.style.cssText = `
        background: white; border-radius: 15px; padding: 25px;
        width: 450px; max-width: 90%; max-height: 90vh; overflow-y: auto;
    `;

    content.innerHTML = `
        <h3>üí∞ Criar Nova Aposta</h3>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                T√≠tulo da Aposta:
            </label>
            <input type="text" id="tituloAposta" 
                   placeholder="Ex: Quem vai vencer o jogo?"
                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                Valor da Aposta (m√©ritos):
            </label>
            <input type="number" id="valorAposta" min="1" max="${calcularMeritoMaximoAposta(usuario)}"
                   placeholder="M√°ximo: ${calcularMeritoMaximoAposta(usuario)}"
                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                Data de Encerramento:
            </label>
            <input type="datetime-local" id="dataEncerramentoAposta"
                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                Op√ß√µes (uma por linha):
            </label>
            <textarea id="opcoesAposta" 
                      placeholder="Time A&#10;Time B&#10;Empate"
                      style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="fecharFormularioAposta()" 
                    style="padding: 10px 20px; background: #f44336; color: white; 
                           border: none; border-radius: 5px; cursor: pointer;">
                Cancelar
            </button>
            <button onclick="confirmarCriacaoAposta('${cardId}')" 
                    style="padding: 10px 20px; background: #4CAF50; color: white; 
                           border: none; border-radius: 5px; cursor: pointer;">
                Criar Aposta
            </button>
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    // Configurar data m√≠nima (amanh√£)
    const dataInput = document.getElementById('dataEncerramentoAposta');
    const amanha = new Date();
    amanha.setDate(amanha.getDate() + 1);
    dataInput.min = amanha.toISOString().slice(0, 16);

    window.fecharFormularioAposta = function() {
        modal.remove();
    };
}
// ===== CONFIRMA√á√ÉO DE CRIA√á√ÉO DE APOSTA =====
function confirmarCriacaoAposta(cardId) {
    const titulo = document.getElementById('tituloAposta').value.trim();
    const valor = parseInt(document.getElementById('valorAposta').value);
    const dataEncerramento = document.getElementById('dataEncerramentoAposta').value;
    const opcoesText = document.getElementById('opcoesAposta').value.trim();

    // Valida√ß√µes
    if (!titulo) {
        alert('Digite um t√≠tulo para a aposta!');
        return;
    }

    if (!valor || valor < 1) {
        alert('Digite um valor v√°lido para a aposta!');
        return;
    }

    if (!dataEncerramento) {
        alert('Selecione uma data de encerramento!');
        return;
    }

    const opcoes = opcoesText.split('\n').filter(opcao => opcao.trim()).map(opcao => opcao.trim());
    if (opcoes.length < 2) {
        alert('Digite pelo menos 2 op√ß√µes para a aposta!');
        return;
    }

    const usuario = usuarioLogado;
    if (!usuario) {
        alert('Voc√™ precisa estar logado!');
        return;
    }

    // Verifica m√©rito suficiente
    if (valor > calcularMeritoMaximoAposta(usuario)) {
        alert(`M√©rito insuficiente! Voc√™ pode apostar no m√°ximo ${calcularMeritoMaximoAposta(usuario)} m√©ritos`);
        return;
    }

    // Encontra ou cria sala de apostas para este card
    let apostaSala = dados.apostasUsuarios.find(s => s.cardId === cardId);
    if (!apostaSala) {
        apostaSala = {
            cardId: cardId,
            criador: usuario.usuario,
            dataCriacao: new Date().toISOString(),
            apostas: []
        };
        dados.apostasUsuarios.push(apostaSala);
    }

    // Cria nova aposta
    const novaAposta = {
        id: Date.now(),
        titulo: titulo,
        valor: valor,
        dataEncerramento: new Date(dataEncerramento).toISOString(),
        opcoes: opcoes,
        criador: usuario.usuario,
        status: 'aberta',
        participantes: [],
        apostas: [],
        comprovantes: []
    };

    apostaSala.apostas.push(novaAposta);

    // Sincroniza e salva
    syncDataToPeers();
    salvarDados();

    // Fecha modais
    window.fecharFormularioAposta();
    const apostasModal = document.querySelector('[style*="z-index: 12000"]');
    if (apostasModal) apostasModal.remove();

    adicionarNotificacao(
        'üí∞ Aposta Criada!',
        `Sua aposta "${titulo}" foi criada com sucesso!`,
        'sucesso'
    );

    // Atualiza indicadores
    atualizarIndicadoresApostas();
    
    alert('üéâ Aposta criada com sucesso!');
}
// ===== FORMUL√ÅRIO PARTICIPAR APOSTA =====
function abrirFormularioParticiparAposta(cardId, apostaId) {
    const apostaSala = dados.apostasUsuarios.find(s => s.cardId === cardId);
    if (!apostaSala) return;

    const aposta = apostaSala.apostas.find(a => a.id == apostaId);
    if (!aposta) return;

    const usuario = usuarioLogado;
    if (!usuario) {
        alert('Fa√ßa login para participar!');
        return;
    }

    // Verifica se j√° participou
    if (aposta.participantes?.some(p => p.usuario === usuario.usuario)) {
        alert('Voc√™ j√° est√° participando desta aposta!');
        return;
    }

    // Verifica m√©rito
    if (aposta.valor > usuario.merito) {
        alert(`M√©rito insuficiente! Voc√™ tem ${usuario.merito} e precisa de ${aposta.valor}`);
        return;
    }

    // Mostra confirma√ß√£o
    const confirmar = confirm(
        `Deseja participar da aposta "${aposta.titulo}"?\n\n` +
        `Valor: ${aposta.valor} m√©ritos\n` +
        `Seu m√©rito atual: ${usuario.merito}\n` +
        `M√©rito ap√≥s aposta: ${usuario.merito - aposta.valor}`
    );

    if (confirmar) {
        confirmarParticipacaoAposta(cardId, apostaId);
    }
}
// ===== MOSTRAR APOSTAS EXISTENTES =====
function mostrarApostasExistentes(cardId) {
    const apostaSala = dados.apostasUsuarios.find(s => s.cardId === cardId);
    if (!apostaSala || !apostaSala.apostas.length) {
        alert('Nenhuma aposta dispon√≠vel para este conte√∫do!');
        return;
    }

    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: flex; justify-content: center;
        align-items: center; z-index: 15000;
    `;

    let apostasHTML = '';
    apostaSala.apostas.forEach(aposta => {
        const participantes = aposta.participantes?.length || 0;
        const statusColor = aposta.status === 'aberta' ? '#4CAF50' : '#f44336';
        
        apostasHTML += `
            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 10px 0; color: #333;">${aposta.titulo}</h4>
                <p style="margin: 5px 0; color: #666;">
                    <strong>Valor:</strong> ${aposta.valor} m√©ritos | 
                    <strong>Participantes:</strong> ${participantes} |
                    <strong>Status:</strong> <span style="color: ${statusColor}">${aposta.status}</span>
                </p>
                <p style="margin: 5px 0; color: #666;">
                    <strong>Encerra:</strong> ${new Date(aposta.dataEncerramento).toLocaleString()}
                </p>
                <!--
                <button onclick="abrirModalApostaDetalhada(${aposta.id})" 
                        style="padding: 8px 15px; background: #2196F3; color: white; 
                               border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                    Ver Detalhes
                </button>
                -->
                ${aposta.status === 'aberta' ? `
                    <button onclick="abrirFormularioParticiparAposta('${cardId}', ${aposta.id})" 
                            style="padding: 8px 15px; background: #4CAF50; color: white; 
                                   border: none; border-radius: 5px; cursor: pointer;">
                        Participar
                    </button>
                ` : ''}
            </div>
        `;
    });

    const content = document.createElement('div');
    content.style.cssText = `
        background: white; border-radius: 15px; padding: 25px;
        width: 500px; max-width: 90%; max-height: 80vh; overflow-y: auto;
    `;

    content.innerHTML = `
        <h3>üí∞ Apostas Dispon√≠veis</h3>
        ${apostasHTML}
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="abrirFormularioCriarAposta('${cardId}')" 
                    style="padding: 10px 20px; background: #FF9800; color: white; 
                           border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                Criar Nova Aposta
            </button>
            <button onclick="modal.remove()" 
                    style="padding: 10px 20px; background: #f44336; color: white; 
                           border: none; border-radius: 5px; cursor: pointer;">
                Fechar
            </button>
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);
}
// ===== ATUALIZA√á√ÉO DE INDICADORES =====
function atualizarIndicadoresApostas() {
    const botoesApostas = document.querySelectorAll('.botao-apostas-custom');
    
    botoesApostas.forEach(botao => {
        // Encontra o cardId associado a este bot√£o
        const videoInfo = botao.closest('.video-info');
        if (!videoInfo) return;
        
        const cardId = gerarCardId(videoInfo);
        const apostaSala = dados.apostasUsuarios.find(s => s.cardId === cardId);
        
        // Remove classe anterior
        botao.classList.remove('with-red-dot');
        
        // Adiciona indicador se houver apostas ativas
        if (apostaSala && apostaSala.apostas.some(a => a.status === 'aberta')) {
            botao.classList.add('with-red-dot');
        }
    });
}
// ===== VERIFICA√á√ÉO DE ENCERRAMENTOS AUTOM√ÅTICOS =====
function verificarEncerramentosAutomaticos() {
    const agora = new Date();
    let atualizou = false;

    dados.apostasUsuarios.forEach(sala => {
        sala.apostas?.forEach(aposta => {
            if (aposta.status === 'aberta' && new Date(aposta.dataEncerramento) < agora) {
                aposta.status = 'encerrada';
                atualizou = true;
                
                adicionarNotificacao(
                    '‚è∞ Aposta Encerrada',
                    `A aposta "${aposta.titulo}" foi encerrada automaticamente`,
                    'alerta'
                );
            }
        });
    });

    if (atualizou) {
        syncDataToPeers();
        salvarDados();
        atualizarIndicadoresApostas();
    }
}
// ===== C√ÅLCULO DE M√âRITO M√ÅXIMO =====
function calcularMeritoMaximoAposta(usuario) {
    if (!usuario) return 0;
    
    // Regras mais realistas:
    // - M√°ximo de 50% do m√©rito atual
    // - M√≠nimo de 10 m√©ritos para poder apostar
    // - M√°ximo absoluto de 1000 m√©ritos por aposta
    
    const maximoPercentual = Math.floor(usuario.merito * 0.5);
    const maximo = Math.min(maximoPercentual, 1000);
    
    return Math.max(maximo, 10); // M√≠nimo de 10 m√©ritos
}
// ===== NOTIFICA√á√ïES ESPEC√çFICAS PARA APOSTAS =====
function adicionarNotificacaoAposta(titulo, mensagem, tipo = 'info') {
    const notificacao = {
        id: Date.now(),
        titulo: `üí∞ ${titulo}`,
        mensagem: mensagem,
        tipo: tipo,
        lida: false,
        data: new Date().toLocaleString(),
        categoria: 'apostas'
    };
    
    // Sua l√≥gica existente de notifica√ß√µes
    if (!notificacoes) notificacoes = [];
    notificacoes.unshift(notificacao);
    
    // Limitar a 50 notifica√ß√µes
    if (notificacoes.length > 50) {
        notificacoes = notificacoes.slice(0, 50);
    }
    
    // Atualizar badge
    atualizarBadgeNotificacoes();
    
    // Mostrar toast
    mostrarToastNotificacao(notificacao);
}
// ===== INICIALIZA√á√ÉO =====
function inicializarSistemaApostasDesafios() {
    console.log('üéØ Inicializando sistema de apostas e desafios...');
    
    // Verifica encerramentos autom√°ticos a cada minuto
    setInterval(verificarEncerramentosAutomaticos, 60000);
    
    // Verifica encerramentos agora tamb√©m
    verificarEncerramentosAutomaticos();
    
    // Inicializa indicadores
    atualizarIndicadoresApostas();
    
    // Observa mudan√ßas no DOM para adicionar bot√µes dinamicamente
    observarDOMParaBotoes();
    
    console.log('‚úÖ Sistema de apostas inicializado!');
}
////1. Ranking de Usu√°rios
//Vamos criar uma fun√ß√£o que exibe um ranking baseado no m√©rito dos usu√°rios.

// ===== SISTEMA DE RANKING CORRIGIDO =====
function exibirRanking() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); display: flex; justify-content: center;
        align-items: center; z-index: 15000;
    `;

    // Calcula ranking baseado em m√©rito
    const ranking = [...dados.usuarios]
        .sort((a, b) => (b.merito || 0) - (a.merito || 0))
        .slice(0, 20);

    let rankingHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    padding: 5px; border-radius: 15px 15px 0 0; text-align: center;">
            <h2 style="color: white; margin: 0;">üèÜ RANKING DE USU√ÅRIOS</h2>
        </div>
        <div style="background: white; padding: 20px; border-radius: 0 0 15px 15px; max-height: 70vh; overflow-y: auto;">
    `;

    ranking.forEach((usuario, index) => {
        const posicao = index + 1;
        const trofeu = posicao === 1 ? 'ü•á' : posicao === 2 ? 'ü•à' : posicao === 3 ? 'ü•â' : `${posicao}¬∞`;
        const isCurrentUser = usuarioLogado && usuario.usuario === usuarioLogado.usuario;
        
        rankingHTML += `
            <div style="display: flex; align-items: center; padding: 12px; 
                        margin: 8px 0; background: ${isCurrentUser ? '#e3f2fd' : '#f8f9fa'}; 
                        border-radius: 10px; border: ${isCurrentUser ? '2px solid #2196F3' : '1px solid #e0e0e0'};">
                <div style="font-size: 24px; margin-right: 15px; width: 50px; text-align: center;">
                    ${trofeu}
                </div>
                <img src="${usuario.imagem || 'default-usuario.png'}" 
                     style="width: 40px; height: 40px; border-radius: 50%; margin-right: 15px;">
                <div style="flex: 1;">
                    <strong style="color: #333;">${usuario.nome}</strong>
                    ${isCurrentUser ? '<span style="color: #2196F3; margin-left: 8px;">(Voc√™)</span>' : ''}
                    <div style="font-size: 12px; color: #666;">
                        @${usuario.usuario} | Desafios: ${usuario.desafiosCumpridos || 0} | Amigos: ${usuario.amigos?.length || 0}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 18px; font-weight: bold; color: #FF9800;">
                        ${usuario.merito || 0} pts
                    </div>
                    <div style="font-size: 11px; color: #666;">
                        M√©rito
                    </div>
                </div>
            </div>
        `;
    });

    rankingHTML += `
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button id="fecharRankingBtn" 
                    style="padding: 12px 30px; background: #f44336; color: white; 
                           border: none; border-radius: 25px; cursor: pointer; font-size: 16px;">
                Fechar Ranking
            </button>
        </div>
    `;

    const content = document.createElement('div');
    content.style.cssText = `
        background: white; border-radius: 20px; 
        width: 600px; max-width: 90%; max-height: 90vh; overflow: hidden;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    `;
    
    content.innerHTML = rankingHTML;
    modal.appendChild(content);
    document.body.appendChild(modal);

    // CORRE√á√ÉO: Adicionar evento de fechamento correto
    const fecharBtn = content.querySelector('#fecharRankingBtn');
    if (fecharBtn) {
        fecharBtn.onclick = function() {
            modal.remove();
            if (overlay && overlay.parentNode) {
                overlay.remove();
            }
        };
    }

    // CORRE√á√ÉO: Overlay para fechar ao clicar fora
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 14999;
    `;
    overlay.onclick = function() {
        modal.remove();
        overlay.remove();
    };
    document.body.appendChild(overlay);

    // CORRE√á√ÉO: Fechar com ESC
    const fecharComESC = function(e) {
        if (e.key === 'Escape') {
            modal.remove();
            overlay.remove();
            document.removeEventListener('keydown', fecharComESC);
        }
    };
    document.addEventListener('keydown', fecharComESC);
}







// ===== RANKING POR CATEGORIA CORRIGIDO =====
function exibirRankingCategoria(categoria) {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); display: flex; justify-content: center;
        align-items: center; z-index: 15000;
    `;

    let ranking = [];
    let titulo = '';
    let corGradiente = '';

    switch(categoria) {
        case 'apostas':
            titulo = 'üéØ MESTRES DAS APOSTAS';
            corGradiente = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
            break;
        case 'desafios':
            titulo = 'üí™ DESAFIADORES SUPREMOS';
            corGradiente = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
            break;
        case 'streamers':
            titulo = 'üé• STREAMERS POPULARES';
            corGradiente = 'linear-gradient(135deg, #E91E63 0%, #C2185B 100%)';
            ranking = [...(dados.usuarios.filter(u => u.role === 'streamer') || [])]
                .sort((a, b) => (b.merito || 0) - (a.merito || 0))
                .slice(0, 10);
            break;
        default:
            titulo = 'üèÜ RANKING GERAL';
            corGradiente = 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)';
            ranking = [...dados.usuarios]
                .sort((a, b) => (b.merito || 0) - (a.merito || 0))
                .slice(0, 10);
    }

    let rankingHTML = `
        <div style="background: ${corGradiente}; 
                    padding: 20px; border-radius: 15px 15px 0 0; text-align: center;">
            <h2 style="color: white; margin: 0;">${titulo}</h2>
        </div>
        <div style="background: white; padding: 20px; border-radius: 0 0 15px 15px;">
    `;

    if (ranking.length === 0) {
        rankingHTML += `<p style="text-align: center; color: #666;">Nenhum usu√°rio nesta categoria ainda.</p>`;
    } else {
        ranking.forEach((usuario, index) => {
            const posicao = index + 1;
            const trofeu = posicao === 1 ? 'ü•á' : posicao === 2 ? 'ü•à' : posicao === 3 ? 'ü•â' : `${posicao}¬∞`;
            
            rankingHTML += `
                <div style="display: flex; align-items: center; padding: 15px; 
                            margin: 10px 0; background: #f8f9fa; border-radius: 10px;">
                    <div style="font-size: 20px; margin-right: 15px; width: 40px; text-align: center;">
                        ${trofeu}
                    </div>
                    <img src="${usuario.imagem || 'default-usuario.png'}" 
                         style="width: 45px; height: 45px; border-radius: 50%; margin-right: 15px;">
                    <div style="flex: 1;">
                        <strong>${usuario.nome}</strong>
                        <div style="font-size: 12px; color: #666;">@${usuario.usuario}</div>
                    </div>
                    <div style="font-size: 16px; font-weight: bold; color: #FF9800;">
                        ${usuario.merito || 0}
                    </div>
                </div>
            `;
        });
    }

    rankingHTML += `
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button id="fecharRankingCategoriaBtn" 
                    style="padding: 10px 25px; background: #666; color: white; 
                           border: none; border-radius: 20px; cursor: pointer;">
                Fechar
            </button>
        </div>
    `;

    const content = document.createElement('div');
    content.style.cssText = `
        background: white; border-radius: 20px; 
        width: 500px; max-width: 90%; max-height: 80vh; overflow-y: auto;
        box-shadow: 0 15px 30px rgba(0,0,0,0.3);
    `;
    
    content.innerHTML = rankingHTML;
    modal.appendChild(content);
    document.body.appendChild(modal);

    // CORRE√á√ÉO: Evento de fechamento
    const fecharBtn = content.querySelector('#fecharRankingCategoriaBtn');
    if (fecharBtn) {
        fecharBtn.onclick = function() {
            modal.remove();
            if (overlay && overlay.parentNode) {
                overlay.remove();
            }
        };
    }

    // CORRE√á√ÉO: Overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 14999;
    `;
    overlay.onclick = function() {
        modal.remove();
        overlay.remove();
    };
    document.body.appendChild(overlay);

    // CORRE√á√ÉO: Fechar com ESC
    const fecharComESC = function(e) {
        if (e.key === 'Escape') {
            modal.remove();
            overlay.remove();
            document.removeEventListener('keydown', fecharComESC);
        }
    };
    document.addEventListener('keydown', fecharComESC);
}
//2. Sistema de Busca Avan√ßada
//Vamos criar uma fun√ß√£o de busca que permite buscar por usu√°rios, jogos, apostas, etc.

// ===== SISTEMA DE BUSCA AVAN√áADA CORRIGIDO =====
function abrirBuscaAvancada() {
    const modal = document.createElement('div');
    modal.id = 'modalBuscaAvancada';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); display: flex; justify-content: center;
        align-items: center; z-index: 20000;
    `;

    const content = document.createElement('div');
    content.style.cssText = `
        background: white; border-radius: 20px; padding: 30px;
        width: 700px; max-width: 90%; max-height: 90vh; overflow-y: auto;
        box-shadow: 0 25px 50px rgba(0,0,0,0.5);
    `;

    content.innerHTML = `
        <div style="text-align: center; margin-bottom: 25px;">
            <h2 style="color: #333; margin: 0 0 10px 0;">üîç BUSCA AVAN√áADA</h2>
            <p style="color: #666; margin: 0;">Encontre usu√°rios, jogos, apostas e muito mais</p>
        </div>

        <div style="position: relative; margin-bottom: 25px;">
            <input type="text" id="inputBuscaGlobal" 
                   placeholder="Digite para buscar..."
                   style="width: 100%; padding: 15px 20px; font-size: 16px;
                          border: 2px solid #e0e0e0; border-radius: 50px;
                          outline: none; transition: all 0.3s ease;">
            <div style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); 
                       color: #666; font-size: 20px;">
                üîç
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
                    gap: 10px; margin-bottom: 25px;">
            <button class="filtro-busca" data-categoria="usuarios"
                    style="padding: 12px; background: #2196F3; color: white; 
                           border: none; border-radius: 10px; cursor: pointer;">
                üë§ Usu√°rios
            </button>
            <button class="filtro-busca" data-categoria="jogos"
                    style="padding: 12px; background: #4CAF50; color: white; 
                           border: none; border-radius: 10px; cursor: pointer;">
                üéÆ Jogos
            </button>
            <button class="filtro-busca" data-categoria="apostas"
                    style="padding: 12px; background: #FF9800; color: white; 
                           border: none; border-radius: 10px; cursor: pointer;">
                üí∞ Apostas
            </button>
            <button class="filtro-busca" data-categoria="desafios"
                    style="padding: 12px; background: #9C27B0; color: white; 
                           border: none; border-radius: 10px; cursor: pointer;">
                üéØ Desafios
            </button>
        </div>

        <div id="resultadosBusca" style="min-height: 200px; max-height: 400px; overflow-y: auto;">
            <div style="text-align: center; color: #999; padding: 50px 0;">
                üîç Digite algo para come√ßar a buscar...
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button id="fecharBuscaBtn"
                    style="padding: 12px 30px; background: #666; color: white; 
                           border: none; border-radius: 25px; cursor: pointer; font-size: 16px;">
                Fechar Busca
            </button>
        </div>
    `;

    modal.appendChild(content);
    document.body.appendChild(modal);

    // CORRE√á√ÉO: Evento de fechamento
    const fecharBtn = content.querySelector('#fecharBuscaBtn');
    if (fecharBtn) {
        fecharBtn.onclick = function() {
            modal.remove();
        };
    }

    // CORRE√á√ÉO: Fechar ao clicar fora
    modal.onclick = function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    };

    // CORRE√á√ÉO: Fechar com ESC
    const fecharComESC = function(e) {
        if (e.key === 'Escape') {
            modal.remove();
            document.removeEventListener('keydown', fecharComESC);
        }
    };
    document.addEventListener('keydown', fecharComESC);

    // Focar no input automaticamente
    setTimeout(() => {
        const input = document.getElementById('inputBuscaGlobal');
        if (input) input.focus();
    }, 100);

    // Event listener para busca em tempo real
    const inputBusca = document.getElementById('inputBuscaGlobal');
    inputBusca.addEventListener('input', function(e) {
        const termo = e.target.value.trim();
        if (termo.length >= 2) {
            executarBuscaGlobal(termo);
        } else {
            document.getElementById('resultadosBusca').innerHTML = `
                <div style="text-align: center; color: #999; padding: 50px 0;">
                    üîç Digite pelo menos 2 caracteres...
                </div>
            `;
        }
    });

    // CORRE√á√ÉO: Event listeners para filtros
    const botoesFiltro = content.querySelectorAll('.filtro-busca');
    botoesFiltro.forEach(botao => {
        botao.addEventListener('click', function() {
            const categoria = this.getAttribute('data-categoria');
            filtrarBusca(categoria);
        });
    });
}
function executarBuscaGlobal(termo) {
    const resultadosDiv = document.getElementById('resultadosBusca');
    const termoLower = termo.toLowerCase();
    
    let resultados = [];

    // Busca em usu√°rios
    const usuariosEncontrados = dados.usuarios.filter(u => 
        u.nome?.toLowerCase().includes(termoLower) || 
        u.usuario?.toLowerCase().includes(termoLower)
    ).map(u => ({ tipo: 'usuario', item: u }));

    // Busca em jogos
    const jogosEncontrados = dados.jogos.filter(j => 
        j.nome?.toLowerCase().includes(termoLower) ||
        j.titulo?.toLowerCase().includes(termoLower)
    ).map(j => ({ tipo: 'jogo', item: j }));

    // Busca em apostas
    const apostasEncontradas = dados.apostasUsuarios.flatMap(sala => 
        sala.apostas?.filter(a => 
            a.titulo?.toLowerCase().includes(termoLower) ||
            a.criador?.toLowerCase().includes(termoLower)
        ).map(a => ({ tipo: 'aposta', item: a, cardId: sala.cardId })) || []
    );

    // Busca em desafios
    const desafiosEncontrados = dados.desafiosUsuarios.flatMap(sala => 
        sala.desafios?.filter(d => 
            d.titulo?.toLowerCase().includes(termoLower) ||
            d.criador?.toLowerCase().includes(termoLower)
        ).map(d => ({ tipo: 'desafio', item: d, cardId: sala.cardId })) || []
    );

    resultados = [
        ...usuariosEncontrados,
        ...jogosEncontrados,
        ...apostasEncontradas,
        ...desafiosEncontrados
    ];

    if (resultados.length === 0) {
        resultadosDiv.innerHTML = `
            <div style="text-align: center; color: #666; padding: 40px 0;">
                <div style="font-size: 48px; margin-bottom: 10px;">üòï</div>
                <h3 style="margin: 0 0 10px 0;">Nenhum resultado encontrado</h3>
                <p>Tente usar termos diferentes ou verifique a ortografia</p>
            </div>
        `;
        return;
    }

    let resultadosHTML = `
        <div style="margin-bottom: 15px; color: #666; font-size: 14px;">
            ${resultados.length} resultado(s) encontrado(s)
        </div>
    `;

    resultados.forEach(resultado => {
        const { tipo, item, cardId } = resultado;
        
        switch(tipo) {
            case 'usuario':
                resultadosHTML += `
                    <div style="display: flex; align-items: center; padding: 12px; 
                                margin: 8px 0; background: #f8f9fa; border-radius: 10px;
                                cursor: pointer;" 
                         onclick="abrirModalPerfilUsuario('${item.usuario}'); document.querySelector('[style*=\"z-index: 20000\"]').remove();">
                        <div style="font-size: 24px; margin-right: 15px;">üë§</div>
                        <div style="flex: 1;">
                            <strong>${item.nome}</strong>
                            <div style="font-size: 12px; color: #666;">@${item.usuario}</div>
                        </div>
                        <div style="color: #FF9800; font-weight: bold;">
                            ${item.merito || 0} pts
                        </div>
                    </div>
                `;
                break;
                
            case 'jogo':
                resultadosHTML += `
                    <div style="display: flex; align-items: center; padding: 12px; 
                                margin: 8px 0; background: #f8f9fa; border-radius: 10px;
                                cursor: pointer;" 
                         onclick="abrirModalGenerico('jogo', '${item.id}');">
                        <div style="font-size: 24px; margin-right: 15px;">üéÆ</div>
                        <div style="flex: 1;">
                            <strong>${item.nome}</strong>
                            <div style="font-size: 12px; color: #666;">
                                ${item.estadios?.length || 0} est√°dio(s)
                            </div>
                        </div>
                    </div>
                `;
                break;
                
            case 'aposta':
                resultadosHTML += `
                    <div style="display: flex; align-items: center; padding: 12px; 
                                margin: 8px 0; background: #f8f9fa; border-radius: 10px;
                                cursor: pointer;" 
                         onclick="abrirFormularioParticiparAposta('${cardId}', ${item.id}); document.querySelector('[style*=\"z-index: 20000\"]').remove();">
                        <div style="font-size: 24px; margin-right: 15px;">üí∞</div>
                        <div style="flex: 1;">
                            <strong>${item.titulo}</strong>
                            <div style="font-size: 12px; color: #666;">
                                Por ${item.criador} | ${item.valor} m√©ritos
                            </div>
                        </div>
                        <div style="color: ${item.status === 'aberta' ? '#4CAF50' : '#f44336'};">
                            ${item.status}
                        </div>
                    </div>
                `;
                break;
                
            case 'desafio':
                resultadosHTML += `
                    <div style="display: flex; align-items: center; padding: 12px; 
                                margin: 8px 0; background: #f8f9fa; border-radius: 10px;
                                cursor: pointer;" 
                         onclick="participarDesafio('${cardId}', ${item.id}); document.querySelector('[style*=\"z-index: 20000\"]').remove();">
                        <div style="font-size: 24px; margin-right: 15px;">üéØ</div>
                        <div style="flex: 1;">
                            <strong>${item.titulo}</strong>
                            <div style="font-size: 12px; color: #666;">
                                Por ${item.criador} | ${item.valor} m√©ritos
                            </div>
                        </div>
                        <div style="color: ${item.status === 'aberto' ? '#4CAF50' : '#f44336'};">
                            ${item.status}
                        </div>
                    </div>
                `;
                break;
        }
    });

    resultadosDiv.innerHTML = resultadosHTML;
}

function filtrarBusca(categoria) {
    const input = document.getElementById('inputBuscaGlobal');
    input.value = categoria;
    input.focus();
    executarBuscaGlobal(categoria);
}
///3. Melhorias no Sistema de Notifica√ß√µes
//Vamos adicionar um sistema de notifica√ß√µes toast mais elaborado e uma badge no √≠cone de notifica√ß√µes.

// ===== SISTEMA DE NOTIFICA√á√ïES CORRIGIDO =====
function mostrarPainelNotificacoes() {
    const modal = document.createElement('div');
    modal.id = 'modalNotificacoes';
    modal.style.cssText = `
        position: fixed; top: 0; right: 0; width: 400px; height: 100vh;
        background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
        z-index: 15000; overflow-y: auto;
    `;

    const notificacoesNaoLidas = notificacoes.filter(n => !n.lida);
    const notificacoesLidas = notificacoes.filter(n => n.lida);

    let notificacoesHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    padding: 20px; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">üîî Notifica√ß√µes</h3>
                <button id="fecharNotificacoesBtn" 
                        style="background: none; border: none; color: white; 
                               font-size: 20px; cursor: pointer;">√ó</button>
            </div>
            <div style="margin-top: 10px; font-size: 14px;">
                ${notificacoesNaoLidas.length} n√£o lida(s)
            </div>
        </div>
        <div style="padding: 15px;">
    `;

    // ... (c√≥digo das notifica√ß√µes permanece o mesmo) ...

    notificacoesHTML += `
        </div>
        <div style="position: sticky; bottom: 0; background: white; padding: 15px; 
                    border-top: 1px solid #e0e0e0; display: flex; gap: 10px;">
            <button onclick="marcarTodasComoLidas()" 
                    style="flex: 1; padding: 10px; background: #2196F3; color: white; 
                           border: none; border-radius: 5px; cursor: pointer;">
                Marcar todas como lida
            </button>
            <button onclick="limparNotificacoes()" 
                    style="flex: 1; padding: 10px; background: #f44336; color: white; 
                           border: none; border-radius: 5px; cursor: pointer;">
                Limpar todas
            </button>
        </div>
    `;

    modal.innerHTML = notificacoesHTML;
    document.body.appendChild(modal);

    // CORRE√á√ÉO: Evento de fechamento
    const fecharBtn = modal.querySelector('#fecharNotificacoesBtn');
    if (fecharBtn) {
        fecharBtn.onclick = function() {
            modal.remove();
            if (overlay && overlay.parentNode) {
                overlay.remove();
            }
        };
    }

    // CORRE√á√ÉO: Overlay para fechar ao clicar fora
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 14999;
    `;
    overlay.onclick = function() {
        modal.remove();
        overlay.remove();
    };
    document.body.appendChild(overlay);

    // CORRE√á√ÉO: Fechar com ESC
    const fecharComESC = function(e) {
        if (e.key === 'Escape') {
            modal.remove();
            overlay.remove();
            document.removeEventListener('keydown', fecharComESC);
        }
    };
    document.addEventListener('keydown', fecharComESC);
}
function criarItemNotificacao(notificacao) {
    const icones = {
        'info': '‚ÑπÔ∏è',
        'sucesso': '‚úÖ',
        'alerta': '‚ö†Ô∏è',
        'aposta': 'üí∞',
        'desafio': 'üéØ',
        'ranking': 'üèÜ',
        'amigo': 'üë•'
    };

    return `
        <div style="padding: 12px; margin: 8px 0; background: ${notificacao.lida ? '#fafafa' : '#e3f2fd'}; 
                    border-radius: 8px; border-left: 4px solid ${notificacao.lida ? '#ccc' : '#2196F3'}; 
                    cursor: pointer;" 
             onclick="marcarNotificacaoComoLida(${notificacao.id})">
            <div style="display: flex; align-items: start;">
                <div style="font-size: 20px; margin-right: 10px;">
                    ${icones[notificacao.tipo] || 'üì¢'}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: ${notificacao.lida ? 'normal' : 'bold'}; 
                                color: #333; margin-bottom: 4px;">
                        ${notificacao.titulo}
                    </div>
                    <div style="font-size: 12px; color: #666; line-height: 1.4;">
                        ${notificacao.mensagem}
                    </div>
                    <div style="font-size: 10px; color: #999; margin-top: 4px;">
                        ${notificacao.data}
                    </div>
                </div>
                ${!notificacao.lida ? `
                    <div style="width: 8px; height: 8px; background: #2196F3; 
                                border-radius: 50%; margin-left: 5px;"></div>
                ` : ''}
            </div>
        </div>
    `;
}
function marcarNotificacaoComoLida(id) {
    const notificacao = notificacoes.find(n => n.id === id);
    if (notificacao) {
        notificacao.lida = true;
        atualizarBadgeNotificacoes();
        // Atualizar UI se o painel estiver aberto
        const painel = document.querySelector('[style*="z-index: 15000"]');
        if (painel) {
            mostrarPainelNotificacoes();
        }
    }
}

function marcarTodasComoLidas() {
    notificacoes.forEach(n => n.lida = true);
    atualizarBadgeNotificacoes();
    mostrarPainelNotificacoes();
}

function adicionarNotificacao(titulo, mensagem, tipo = 'info') {
    const notificacao = {
        id: Date.now() + Math.random(),
        titulo: titulo,
        mensagem: mensagem,
        tipo: tipo,
        lida: false,
        data: new Date().toLocaleString('pt-BR')
    };
    
    notificacoes.unshift(notificacao);
    
    // Limitar a 100 notifica√ß√µes
    if (notificacoes.length > 100) {
        notificacoes = notificacoes.slice(0, 100);
    }
    
    // Mostrar toast
    mostrarToastNotificacao(notificacao);
    
    // Atualizar badge
    atualizarBadgeNotificacoes();
    
    return notificacao.id;
}
function mostrarToastNotificacao(notificacao) {
    const toast = document.createElement('div');
    toast.className = 'toast-notificacao';
    toast.style.cssText = `
        position: fixed; top: 20px; right: 20px; 
        background: ${getCorNotificacao(notificacao.tipo)};
        color: white; padding: 15px 20px; border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 20000;
        max-width: 350px; animation: slideInRight 0.3s ease;
        display: flex; align-items: center; gap: 10px;
        cursor: pointer;
    `;
    
    const icones = {
        'info': '‚ÑπÔ∏è',
        'sucesso': '‚úÖ',
        'alerta': '‚ö†Ô∏è',
        'aposta': 'üí∞',
        'desafio': 'üéØ'
    };
    
    toast.innerHTML = `
        <div style="font-size: 20px;">${icones[notificacao.tipo] || 'üì¢'}</div>
        <div style="flex: 1;">
            <strong>${notificacao.titulo}</strong>
            <div style="font-size: 13px; margin-top: 2px; opacity: 0.9;">${notificacao.mensagem}</div>
        </div>
        <button onclick="this.parentElement.remove()" 
                style="background: none; border: none; color: white; 
                       cursor: pointer; font-size: 16px; padding: 0; margin-left: 10px;">
            √ó
        </button>
    `;
    
    document.body.appendChild(toast);
    
    // Remove automaticamente ap√≥s 5 segundos
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
    
    // Click para marcar como lida
    toast.onclick = function() {
        marcarNotificacaoComoLida(notificacao.id);
        toast.remove();
    };
}
function getCorNotificacao(tipo) {
    const cores = {
        'sucesso': '#4CAF50',
        'alerta': '#FF9800',
        'aposta': '#FF9800',
        'desafio': '#9C27B0',
        'info': '#2196F3'
    };
    return cores[tipo] || '#2196F3';
}
function atualizarBadgeNotificacoes() {
    const naoLidas = notificacoes.filter(n => !n.lida).length;
    const badge = document.getElementById('badgeNotificacoes') || criarBadgeNotificacoes();
    
    if (naoLidas > 0) {
        badge.textContent = naoLidas > 99 ? '99+' : naoLidas.toString();
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}
function criarBadgeNotificacoes() {
    const badge = document.createElement('div');
    badge.id = 'badgeNotificacoes';
    badge.style.cssText = `
        position: fixed; top: 15px; right: 15px; 
        background: #f44336; color: white; 
        border-radius: 50%; width: 22px; height: 22px;
        display: none; align-items: center; justify-content: center;
        font-size: 12px; font-weight: bold; z-index: 10000;
        cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    `;
    
    badge.onclick = mostrarPainelNotificacoes;
    document.body.appendChild(badge);
    return badge;
}

///4. Sistema de Eventos
//Vamos criar um sistema de eventos para atividades no site, como novos jogos, apostas, etc.

// ===== SISTEMA DE EVENTOS =====
//let eventos = [];

function adicionarEvento(titulo, descricao, tipo = 'info', duracaoHoras = 24) {
    const evento = {
        id: Date.now(),
        titulo: titulo,
        descricao: descricao,
        tipo: tipo,
        dataInicio: new Date(),
        dataFim: new Date(Date.now() + duracaoHoras * 60 * 60 * 1000),
        ativo: true
    };
    
    eventos.unshift(evento);
    
    // Limitar a 50 eventos
    if (eventos.length > 50) {
        eventos = eventos.slice(0, 50);
    }
    
    // Notificar sobre novo evento
    adicionarNotificacao('üéâ Novo Evento!', titulo, 'info');
    
    return evento.id;
}

function mostrarPainelEventos() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; border-radius: 20px; padding: 0;
        width: 600px; max-width: 90%; max-height: 80vh; overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 15000;
    `;

    const eventosAtivos = eventos.filter(e => e.ativo && new Date(e.dataFim) > new Date());
    const eventosPassados = eventos.filter(e => !e.ativo || new Date(e.dataFim) <= new Date());

    let eventosHTML = `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    padding: 25px; border-radius: 20px 20px 0 0; color: white; text-align: center;">
            <h2 style="margin: 0 0 10px 0;">üìÖ EVENTOS E TORNEIOS</h2>
            <p style="margin: 0; opacity: 0.9;">Participe e ganhe recompensas especiais!</p>
        </div>
        <div style="padding: 25px;">
    `;

    // Eventos ativos
    if (eventosAtivos.length > 0) {
        eventosHTML += `<h3 style="color: #333; margin-bottom: 15px;">üéØ Eventos Ativos</h3>`;
        
        eventosAtivos.forEach(evento => {
            const tempoRestante = calcularTempoRestante(evento.dataFim);
            
            eventosHTML += `
                <div style="border: 2px solid #4CAF50; border-radius: 12px; padding: 15px; 
                            margin-bottom: 15px; background: #f1f8e9;">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <h4 style="margin: 0 0 8px 0; color: #2E7D32;">${evento.titulo}</h4>
                        <span style="background: #4CAF50; color: white; padding: 4px 8px; 
                                     border-radius: 12px; font-size: 12px;">
                            ‚è±Ô∏è ${tempoRestante}
                        </span>
                    </div>
                    <p style="margin: 0 0 10px 0; color: #555;">${evento.descricao}</p>
                    <button onclick="participarEvento(${evento.id})" 
                            style="background: #4CAF50; color: white; border: none; 
                                   padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                        Participar
                    </button>
                </div>
            `;
        });
    } else {
        eventosHTML += `
            <div style="text-align: center; padding: 30px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 10px;">üìÖ</div>
                <h3 style="margin: 0 0 10px 0;">Nenhum evento ativo</h3>
                <p>Volte mais tarde para novos eventos e torneios!</p>
            </div>
        `;
    }

    // Eventos passados
    if (eventosPassados.length > 0) {
        eventosHTML += `
            <h3 style="color: #333; margin: 25px 0 15px 0;">üìö Eventos Passados</h3>
            <div style="opacity: 0.7;">
        `;
        
        eventosPassados.slice(0, 5).forEach(evento => {
            eventosHTML += `
                <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; 
                            margin-bottom: 10px; background: #fafafa;">
                    <div style="font-weight: bold; color: #666;">${evento.titulo}</div>
                    <div style="font-size: 12px; color: #999;">
                        ${new Date(evento.dataInicio).toLocaleDateString('pt-BR')}
                    </div>
                </div>
            `;
        });
        
        eventosHTML += `</div>`;
    }

    eventosHTML += `
        </div>
        <div style="text-align: center; padding: 20px; border-top: 1px solid #e0e0e0;">
            <button onclick="modal.remove()" 
                    style="padding: 12px 30px; background: #666; color: white; 
                           border: none; border-radius: 25px; cursor: pointer; font-size: 16px;">
                Fechar
            </button>
        </div>
    `;

    modal.innerHTML = eventosHTML;
    document.body.appendChild(modal);

    // Overlay
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 14999;
    `;
    overlay.onclick = () => {
        modal.remove();
        overlay.remove();
    };
    document.body.appendChild(overlay);
}
function calcularTempoRestante(dataFim) {
    const agora = new Date();
    const fim = new Date(dataFim);
    const diff = fim - agora;
    
    if (diff <= 0) return 'Encerrado';
    
    const horas = Math.floor(diff / (1000 * 60 * 60));
    const minutos = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    if (horas > 0) {
        return `${horas}h ${minutos}m`;
    } else {
        return `${minutos}m`;
    }
}

function participarEvento(eventoId) {
    const evento = eventos.find(e => e.id === eventoId);
    if (!evento) return;
    
    adicionarNotificacao(
        'üéâ Inscri√ß√£o Confirmada!',
        `Voc√™ est√° participando do evento: ${evento.titulo}`,
        'sucesso'
    );
    
    // Aqui voc√™ pode adicionar l√≥gica espec√≠fica para cada tipo de evento
    if (evento.titulo.includes('Torneio')) {
        // L√≥gica para torneios
        setTimeout(() => {
            adicionarNotificacao(
                '‚öîÔ∏è Torneio Iniciado!',
                'O torneio come√ßou! Boa sorte!',
                'alerta'
            );
        }, 2000);
    }
}

// ===== EVENTOS AUTOM√ÅTICOS =====
function criarEventosAutomaticos() {
    // Evento de fim de semana
    const hoje = new Date();
    if (hoje.getDay() === 6 || hoje.getDay() === 0) { // S√°bado ou Domingo
        adicionarEvento(
            'üéä Evento de Fim de Semana',
            'Ganhe o dobro de m√©ritos em todas as apostas e desafios!',
            'sucesso',
            48
        );
    }
    
    // Evento mensal
    if (hoje.getDate() === 1) { // Primeiro dia do m√™s
        adicionarEvento(
            'üìà Ranking Mensal',
            'Competi√ß√£o especial do ranking mensal! Os 3 primeiros ganham b√¥nus!',
            'info',
            720 // 30 dias
        );
    }
    
    // Evento aleat√≥rio
    if (Math.random() > 0.7) {
        const eventosAleatorios = [
            {
                titulo: '‚ö° Evento Rel√¢mpago',
                descricao: 'Apostas r√°pidas! Tempo limitado para participar!',
                duracao: 2
            },
            {
                titulo: 'üéØ Desafio em Grupo',
                descricao: 'Forme times e compita por pr√™mios especiais!',
                duracao: 12
            },
            {
                titulo: 'üí∞ B√¥nus de M√©rito',
                descricao: 'Todas as apostas d√£o 50% mais m√©ritos!',
                duracao: 6
            }
        ];
        
        const eventoAleatorio = eventosAleatorios[Math.floor(Math.random() * eventosAleatorios.length)];
        adicionarEvento(
            eventoAleatorio.titulo,
            eventoAleatorio.descricao,
            'alerta',
            eventoAleatorio.duracao
        );
    }
}

// Inicializar eventos autom√°ticos
setInterval(criarEventosAutomaticos, 60 * 60 * 1000); // A cada hora
criarEventosAutomaticos(); // Executar uma vez ao iniciar
// ===== MENU PRINCIPAL CORRIGIDO =====
function criarMenuPrincipal() {
    // Verificar se o menu j√° existe
    if (document.getElementById('menuPrincipal')) {
        return;
    }

    const menu = document.createElement('div');
    menu.id = 'menuPrincipal';
    menu.style.cssText = `
        position: fixed; top: 10px; left: 10px; z-index: 1000;
        background: white; border-radius: 15px; padding: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2); min-width: 200px;
    `;

    const botoes = [
        { emoji: 'üèÜ', texto: 'Ranking', onclick: 'exibirRanking()' },
        { emoji: 'üîç', texto: 'Buscar', onclick: 'abrirBuscaAvancada()' },
        { emoji: 'üìÖ', texto: 'Eventos', onclick: 'mostrarPainelEventos()' },
        { emoji: 'üí∞', texto: 'Apostas', onclick: 'mostrarApostasGlobais()' },
        { emoji: 'üéØ', texto: 'Desafios', onclick: 'mostrarDesafiosGlobais()' },
        { emoji: 'üë§', texto: 'Perfil', onclick: 'verPerfilCompleto()' },
        { emoji: '‚öôÔ∏è', texto: 'Configura√ß√µes', onclick: 'abrirConfiguracoes()' }
    ];

    let menuHTML = `
        <div style="text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
            <h3 style="margin: 0; color: #333;">üéÆ Menu Principal</h3>
        </div>
    `;

    botoes.forEach(botao => {
        menuHTML += `
            <button onclick="${botao.onclick}" 
                    style="display: flex; align-items: center; width: 100%; padding: 12px 15px;
                           background: none; border: none; border-radius: 8px; cursor: pointer;
                           margin-bottom: 5px; transition: background 0.3s ease;">
                <span style="font-size: 18px; margin-right: 10px;">${botao.emoji}</span>
                <span style="flex: 1; text-align: left;">${botao.texto}</span>
            </button>
        `;
    });

    menuHTML += `
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
            <button onclick="fecharMenuPrincipal()" 
                    style="width: 100%; padding: 8px; background: #f44336; color: white;
                           border: none; border-radius: 5px; cursor: pointer;">
                Fechar Menu
            </button>
        </div>
    `;

    menu.innerHTML = menuHTML;
    document.body.appendChild(menu);

    // Adicionar hover effects
    const botoesMenu = menu.querySelectorAll('button');
    botoesMenu.forEach(btn => {
        btn.addEventListener('mouseenter', () => {
            btn.style.background = '#f0f0f0';
        });
        btn.addEventListener('mouseleave', () => {
            btn.style.background = 'none';
        });
    });

    return menu;
}

function fecharMenuPrincipal() {
    const menu = document.getElementById('menuPrincipal');
    if (menu) {
        menu.remove();
    }
}
// ===== FUN√á√ÉO AUXILIAR PARA CRIAR MODAIS =====
function criarModal(conteudoHTML, opcoes = {}) {
    const {
        largura = '600px',
        maxAltura = '80vh',
        fecharComESC = true,
        fecharClickFora = true
    } = opcoes;

    const modal = document.createElement('div');
    modal.className = 'modal-custom';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: flex; justify-content: center;
        align-items: center; z-index: 15000;
    `;

    const content = document.createElement('div');
    content.style.cssText = `
        background: white; border-radius: 15px; padding: 0;
        width: ${largura}; max-width: 90%; max-height: ${maxAltura};
        overflow-y: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    `;
    
    content.innerHTML = conteudoHTML;
    modal.appendChild(content);
    document.body.appendChild(modal);

    // Overlay para fechar ao clicar fora
    if (fecharClickFora) {
        modal.onclick = function(e) {
            if (e.target === modal) {
                fecharModal(modal);
            }
        };
    }

    // Fechar com ESC
    if (fecharComESC) {
        const fecharComESC = function(e) {
            if (e.key === 'Escape') {
                fecharModal(modal);
                document.removeEventListener('keydown', fecharComESC);
            }
        };
        document.addEventListener('keydown', fecharComESC);
    }

    return { modal, content };
}

function fecharModal(modal) {
    if (modal && modal.parentNode) {
        modal.parentNode.removeChild(modal);
    }
}

// ===== EXEMPLO DE USO DA FUN√á√ÉO AUXILIAR =====
function abrirModalSimples(titulo, mensagem) {
    const conteudoHTML = `
        <div style="padding: 30px; text-align: center;">
            <h3 style="margin: 0 0 15px 0;">${titulo}</h3>
            <p style="margin: 0 0 20px 0; color: #666;">${mensagem}</p>
            <button onclick="fecharModal(this.closest('.modal-custom'))" 
                    style="padding: 10px 25px; background: #2196F3; color: white;
                           border: none; border-radius: 5px; cursor: pointer;">
                Fechar
            </button>
        </div>
    `;

    criarModal(conteudoHTML, { largura: '400px' });
}

// ===== FUN√á√ïES GLOBAIS =====
function mostrarApostasGlobais() {
    // Mostrar todas as apostas dispon√≠veis no sistema
    const cardIds = [...new Set(dados.apostasUsuarios.map(a => a.cardId))];
    if (cardIds.length === 0) {
        alert('Nenhuma aposta dispon√≠vel no momento!');
        return;
    }
    
    // Aqui voc√™ pode implementar uma visualiza√ß√£o global de apostas
    mostrarApostasExistentes(cardIds[0]);
}

function mostrarDesafiosGlobais() {
    // Similar √† fun√ß√£o de apostas globais
    const cardIds = [...new Set(dados.desafiosUsuarios.map(d => d.cardId))];
    if (cardIds.length === 0) {
        alert('Nenhum desafio dispon√≠vel no momento!');
        return;
    }
    
    // Implementar visualiza√ß√£o global de desafios
    alert('Sistema de desafios globais em desenvolvimento!');
}

function abrirConfiguracoes() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: white; border-radius: 15px; padding: 25px;
        width: 400px; max-width: 90%; z-index: 15000;
        box-shadow: 0 15px 30px rgba(0,0,0,0.3);
    `;

    modal.innerHTML = `
        <h3 style="margin: 0 0 20px 0; text-align: center;">‚öôÔ∏è Configura√ß√µes</h3>
        
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                üîî Notifica√ß√µes
            </label>
            <select style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="all">Todas as notifica√ß√µes</option>
                <option value="important">Apenas importantes</option>
                <option value="none">Desativar</option>
            </select>
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                üéµ Som de Notifica√ß√µes
            </label>
            <select style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="on">Ativado</option>
                <option value="off">Desativado</option>
            </select>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">
                üåô Tema
            </label>
            <select style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="light">Claro</option>
                <option value="dark">Escuro</option>
                <option value="auto">Autom√°tico</option>
            </select>
        </div>

        <div style="display: flex; gap: 10px;">
            <button onclick="modal.remove()" 
                    style="flex: 1; padding: 10px; background: #666; color: white; 
                           border: none; border-radius: 5px; cursor: pointer;">
                Cancelar
            </button>
            <button onclick="salvarConfiguracoes(); modal.remove();" 
                    style="flex: 1; padding: 10px; background: #4CAF50; color: white; 
                           border: none; border-radius: 5px; cursor: pointer;">
                Salvar
            </button>
        </div>
    `;

    document.body.appendChild(modal);

    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.5); z-index: 14999;
    `;
    overlay.onclick = () => {
        modal.remove();
        overlay.remove();
    };
    document.body.appendChild(overlay);
}

function salvarConfiguracoes() {
    adicionarNotificacao('‚öôÔ∏è Configura√ß√µes', 'Configura√ß√µes salvas com sucesso!', 'sucesso');
}

// ===== INICIALIZA√á√ÉO DO SISTEMA =====
function inicializarSistemaCompleto() {
    console.log('üöÄ Inicializando sistema completo...');
    
    // Criar menu principal
    criarMenuPrincipal();
    
    // Inicializar badge de notifica√ß√µes
    criarBadgeNotificacoes();
    
    // Inicializar sistema de apostas
    inicializarSistemaApostasDesafios();
    
    // Criar eventos autom√°ticos
    criarEventosAutomaticos();
    
    // Adicionar notifica√ß√£o de boas-vindas
    setTimeout(() => {
        adicionarNotificacao(
            'üéâ Bem-vindo!',
            'Sistema completo carregado com sucesso!',
            'sucesso'
        );
    }, 1000);
    
    console.log('‚úÖ Sistema completo inicializado!');
}

// Inicializar quando o DOM estiver pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarSistemaCompleto);
} else {
    inicializarSistemaCompleto();
}
// Inicialize o menu flutuante quando o DOM estiver pronto

// Inicializa quando o DOM estiver pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarSistemaApostasDesafios);
} else {
    inicializarSistemaApostasDesafios();
}













</script>
    <!-- Carregar scripts 
    <script src="variaveis-globais.js"></script>
    <script src="funcoes-auxiliares.js"></script>
    <script src="storage.js"></script>
    
    
    <script src="Perfil/login.js"></script>
    <script src="Perfil/merito.js"></script>
    <script src="Perfil/ranking.js"></script>
    <script src="Perfil/social.js"></script>
    <script src="Perfil/notificacoes.js"></script>





    
    
    <script src="Wrtc/Chat/ModalChat.js"></script>
    <script src="Wrtc/Chat/Chat.js"></script>
    <script src="Wrtc/Chat/Voice.js"></script>

    <script src="Wrtc/Apostas/ModalApostas.js"></script>
    <script src="Wrtc/Apostas/apostas.js"></script>
    <script src="Wrtc/Wrtc_geral.js"></script>
  
    <script src="Header/busca.js"></script>
    <script src="Header/navegacao.js"></script>

    
    
    
    <script src="Eventos/jogos.js"></script>
    <script src="Eventos/estadios.js"></script>
    <script src="Eventos/times.js"></script>
    <script src="Eventos/streamers.js"></script>
    <script src="Eventos/Lives/lives-manager.js"></script>
    <script src="Eventos/Lives/cards.js"></script>
    <script src="Eventos/Lives/divs-horizontais.js"></script>
    <script src="Eventos/Lives/BotoesNoheader.js"></script>
    <script src="Eventos/Lives/TamanhoDosIframes.js"></script>
    <script src="Eventos/Lives/dropdownButton.js"></script>

    -->
  
</body>
</html>
