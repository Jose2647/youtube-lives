





<!DOCTYPE html>
<html>
<head>
    <title>Chat Simples</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <div>
        <h3>Conectar</h3>
        <input type="text" id="serverUrl" value="http://localhost:3000" placeholder="URL do servidor">
        <input type="text" id="userName" value="UsuarioTeste" placeholder="Seu nome">
        <button onclick="connectSocket()">Conectar</button>
        <button onclick="disconnectSocket()">Desconectar</button>
    </div>

    <div>
        <h3>Entrar em Sala</h3>
        <select id="roomType">
            <option value="jogo">Jogo</option>
            <option value="time">Time</option>
            <option value="live">Live</option>
        </select>
        <input type="text" id="roomId" value="123" placeholder="ID">
        <button onclick="joinRoom()">Entrar</button>
        <button onclick="leaveRoom()">Sair</button>
    </div>

    <div>
        <h3>Mensagens</h3>
        <div id="messages" style="border:1px solid #ccc; height:300px; overflow-y:scroll; padding:10px;"></div>
        <input type="text" id="messageInput" placeholder="Digite sua mensagem" style="width:70%">
        <button onclick="sendMessage()">Enviar</button>
    </div>

    <script>
        let socket = null;
        let currentRoom = null;
        let currentRoomType = null;
        let currentRoomId = null;
        let userName = '';

        function connectSocket() {
            const serverUrl = document.getElementById('serverUrl').value;
            userName = document.getElementById('userName').value;
            socket = io(serverUrl);

            socket.on('connect', () => {
                addMessage('Sistema', 'Conectado ao servidor');
            });

            socket.on('disconnect', () => {
                addMessage('Sistema', 'Desconectado');
            });

            socket.on('chat-message', (data) => {
                addMessage(data.usuario, data.mensagem);
            });

            socket.on('chat-history', (history) => {
                // Limpa mensagens antes de carregar histórico
                document.getElementById('messages').innerHTML = '';
                history.forEach(msg => {
                    addMessage(msg.usuario, msg.mensagem);
                });
            });
        }

        function disconnectSocket() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        function joinRoom() {
            if (!socket) {
                alert('Conecte primeiro');
                return;
            }

            currentRoomType = document.getElementById('roomType').value;
            currentRoomId = document.getElementById('roomId').value;
            userName = document.getElementById('userName').value;

            currentRoom = currentRoomType + '-' + currentRoomId + '-visitante';

            socket.emit('join-' + currentRoomType, {
                [currentRoomType + 'Id']: currentRoomId,
                user: userName,
                merito: 0
            });

            socket.emit('request-chat-history', { room: currentRoom });

            addMessage('Sistema', 'Entrou na sala: ' + currentRoom);
        }

        function leaveRoom() {
            if (socket && currentRoom) {
                socket.emit('leave-room', { room: currentRoom });
                addMessage('Sistema', 'Saiu da sala: ' + currentRoom);
                currentRoom = null;
                currentRoomType = null;
                currentRoomId = null;
            }
        }

        function sendMessage() {
            if (!socket || !currentRoom) {
                alert('Conecte e entre em uma sala primeiro');
                return;
            }

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value;

            if (message.trim() === '') return;

            // Envia no formato que seu backend espera
            const messageData = {
                user: userName,
                message: message,
                merito: 0
            };

            // Adiciona o campo específico baseado no tipo de sala
            if (currentRoomType === 'jogo') {
                messageData.jogoId = currentRoomId;
            } else if (currentRoomType === 'time') {
                messageData.timeId = currentRoomId;
            } else if (currentRoomType === 'live') {
                messageData.liveId = currentRoomId;
            }

            // ADICIONA A MENSAGEM LOCALMENTE ANTES DE ENVIAR
            addMessage(userName, message);

            // Envia para o servidor
            socket.emit('chat-message', messageData);
            
            // Limpa o input
            messageInput.value = '';
        }

        function addMessage(user, text) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.innerHTML = `<strong>${user}:</strong> ${text}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Enter para enviar mensagem
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>