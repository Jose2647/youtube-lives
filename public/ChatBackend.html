<!DOCTYPE html>
<html>
<head>
    <title>Chat Multi-Salas</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <div>
        <h3>Conectar</h3>
        <input type="text" id="serverUrl" value="http://localhost:3000" placeholder="URL do servidor">
        <input type="text" id="userName" value="UsuarioTeste" placeholder="Seu nome">
        <button onclick="connectsocketChat()">Conectar</button>
        <button onclick="disconnectsocketChat()">Desconectar</button>
    </div>

    <div>
        <h3>Entrar em Salas</h3>
        <select id="roomType">
            <option value="jogo">Jogo</option>
            <option value="time">Time</option>
            <option value="live">Live</option>
        </select>
        <input type="text" id="roomId" value="123" placeholder="ID">
        <button onclick="joinRoom()">Entrar na Sala</button>
        
        <h4>Salas Ativas:</h4>
        <div id="activeRooms" style="border:1px solid #ccc; height:100px; overflow-y:scroll; padding:10px; margin:10px 0;"></div>
    </div>

    <div>
        <h3>Mensagens</h3>
        <select id="roomSelector" onchange="switchRoom()" style="margin-bottom:10px;">
            <option value="">-- Selecionar Sala --</option>
        </select>
        <div id="messages" style="border:1px solid #ccc; height:300px; overflow-y:scroll; padding:10px;"></div>
        <input type="text" id="messageInput" placeholder="Digite sua mensagem" style="width:70%">
        <button onclick="sendMessage()">Enviar</button>
    </div>

    <script>
        let socketChat = null;
        let userName = '';
        let activeRooms = new Map(); // Map para armazenar salas e suas mensagens
        let currentRoom = ''; // Sala atual selecionada para visualizar

        function connectsocketChat() {
            const serverUrl = document.getElementById('serverUrl').value;
            userName = document.getElementById('userName').value;
            socketChat = io(serverUrl);

            socketChat.on('connect', () => {
                addMessage('Sistema', 'Conectado ao servidor', 'system');
            });

            socketChat.on('disconnect', () => {
                addMessage('Sistema', 'Desconectado', 'system');
            });

            socketChat.on('chat-message', (data) => {
                // Determina qual sala a mensagem pertence
                const room = data.room || getRoomFromData(data);
                addMessage(data.usuario, data.mensagem, room);
            });

            socketChat.on('chat-history', (history) => {
                // Isso vai carregar hist√≥rico quando entrar em uma sala espec√≠fica
                // Mas como estamos em m√∫ltiplas salas, vamos lidar diferente
            });
        }

        function disconnectsocketChat() {
            if (socketChat) {
                socketChat.disconnect();
                socketChat = null;
                activeRooms.clear();
                updateRoomSelector();
                updateActiveRoomsDisplay();
            }
        }

        function joinRoom() {
            if (!socketChat) {
                alert('Conecte primeiro');
                return;
            }

            const roomType = document.getElementById('roomType').value;
            const roomId = document.getElementById('roomId').value;
            const roomName = `${roomType}-${roomId}-visitante`;

            // Se j√° est√° na sala, n√£o faz nada
            if (activeRooms.has(roomName)) {
                addMessage('Sistema', `J√° est√° na sala ${roomName}`, 'system');
                return;
            }

            // Entra na sala via socketChat
            socketChat.emit('join-' + roomType, {
                [roomType + 'Id']: roomId,
                user: userName,
                merito: 0
            });

            // Adiciona sala √† lista local
            activeRooms.set(roomName, []);
            
            // Se √© a primeira sala, seleciona automaticamente
            if (activeRooms.size === 1) {
                currentRoom = roomName;
            }

            updateRoomSelector();
            updateActiveRoomsDisplay();
            addMessage('Sistema', `Entrou na sala: ${roomName}`, 'system');

            // Solicita hist√≥rico da sala
            socketChat.emit('request-chat-history', { room: roomName });
        }

        function switchRoom() {
            const selector = document.getElementById('roomSelector');
            currentRoom = selector.value;
            displayMessagesForCurrentRoom();
        }

        function sendMessage() {
            if (!socketChat || !currentRoom) {
                alert('Conecte e entre em uma sala primeiro');
                return;
            }

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value;

            if (message.trim() === '') return;

            // Extrai tipo e ID da sala atual
            const [roomType, roomId] = currentRoom.split('-');

            // Envia no formato que seu backend espera
            const messageData = {
                user: userName,
                message: message,
                merito: 0
            };

            // Adiciona o campo espec√≠fico baseado no tipo de sala
            if (roomType === 'jogo') {
                messageData.jogoId = roomId;
            } else if (roomType === 'time') {
                messageData.timeId = roomId;
            } else if (roomType === 'live') {
                messageData.liveId = roomId;
            }

            // Adiciona a mensagem localmente
            addMessage(userName, message, currentRoom);

            // Envia para o servidor
            socketChat.emit('chat-message', messageData);
            
            // Limpa o input
            messageInput.value = '';
        }

        function addMessage(user, text, room) {
            // Se a mensagem √© do sistema, mostra em todas as views
            if (room === 'system') {
                // Adiciona a todas as salas ativas
                activeRooms.forEach((messages, roomName) => {
                    messages.push({ user, text, timestamp: new Date() });
                });
            } else {
                // Adiciona apenas √† sala espec√≠fica
                if (activeRooms.has(room)) {
                    activeRooms.get(room).push({ user, text, timestamp: new Date() });
                }
            }

            // Se a sala da mensagem √© a atual, mostra imediatamente
            if (room === currentRoom || room === 'system') {
                displayMessagesForCurrentRoom();
            }
        }

        function displayMessagesForCurrentRoom() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';

            if (currentRoom && activeRooms.has(currentRoom)) {
                const messages = activeRooms.get(currentRoom);
                messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.innerHTML = `<strong>${msg.user}:</strong> ${msg.text}`;
                    messagesDiv.appendChild(messageDiv);
                });
            }

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateRoomSelector() {
            const selector = document.getElementById('roomSelector');
            selector.innerHTML = '<option value="">-- Selecionar Sala --</option>';
            
            activeRooms.forEach((messages, roomName) => {
                const option = document.createElement('option');
                option.value = roomName;
                option.textContent = roomName;
                option.selected = (roomName === currentRoom);
                selector.appendChild(option);
            });
        }

        function updateActiveRoomsDisplay() {
            const display = document.getElementById('activeRooms');
            display.innerHTML = '';
            
            activeRooms.forEach((messages, roomName) => {
                const roomDiv = document.createElement('div');
                roomDiv.innerHTML = `üìÅ ${roomName} (${messages.length} mensagens)`;
                display.appendChild(roomDiv);
            });
        }

        function getRoomFromData(data) {
            // Tenta determinar a sala baseado nos dados recebidos
            if (data.jogoId) return `jogo-${data.jogoId}-visitante`;
            if (data.timeId) return `time-${data.timeId}-visitante`;
            if (data.liveId) return `live-${data.liveId}-visitante`;
            return data.room || 'unknown';
        }

        // Enter para enviar mensagem
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>